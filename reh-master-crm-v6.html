<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>re:H Master CRM — JNA Corporation</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#F5F6F8;--wh:#FFFFFF;--s2:#F0F2F5;--s3:#E4E7EC;--bd:#DFE2E8;--bl:#ECEEF2;
--tx:#171A23;--t2:#3D4355;--t3:#6B7186;--t4:#9CA3B5;
--pr:#13705E;--pl:#E4F4EF;--ph:#0E5A4B;
--blu:#3563E9;--bll:#EBF0FD;--org:#D97A1E;--orl:#FDF3E7;
--red:#CC3D4A;--rl:#FBEBEC;--pur:#6B4FCA;--pul:#EFECFB;
--gld:#B08C26;--gll:#FBF6E8;--cyn:#0E8A9B;--cyl:#E4F6F8;
--su:#178C5E;--sl:#E4F4EF;--wr:#D97A1E;--wl:#FDF3E7;--dg:#CC3D4A;--dl:#FBEBEC;
--sbw:244px;--hdh:56px;--r:8px;--rs:5px;
--sh:0 1px 3px rgba(23,26,35,.05);--sh2:0 4px 14px rgba(23,26,35,.08);--sh3:0 8px 28px rgba(23,26,35,.1);
--tr:.16s ease;
}
html{font-size:13.5px}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);overflow:hidden;height:100vh;-webkit-font-smoothing:antialiased}
::selection{background:var(--pr);color:#fff}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--s3);border-radius:9px}
#loginScreen{position:fixed;inset:0;z-index:9999;display:flex;background:linear-gradient(135deg,#0a1a14 0%,#0d2e22 40%,#112a20 100%)}
#loginScreen.hidden{display:none}
.login-left{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:60px;position:relative;overflow:hidden}
.login-left::before{content:'';position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(19,112,94,.15),transparent 70%);top:-100px;right:-200px}
.login-brand{margin-bottom:48px;text-align:center;position:relative;z-index:1}
.login-logo{width:72px;height:72px;border-radius:18px;background:linear-gradient(135deg,var(--pr),#2BA88A);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff;letter-spacing:-1px;margin:0 auto 20px;box-shadow:0 8px 32px rgba(19,112,94,.3)}
.login-brand h1{font-family:'Playfair Display',serif;font-size:32px;font-weight:700;color:#fff;letter-spacing:-.5px;margin-bottom:6px}
.login-brand p{font-size:14px;color:rgba(255,255,255,.5)}
.login-form{width:380px;max-width:100%;position:relative;z-index:1}
.login-form .fg{margin-bottom:18px}
.login-form label{display:block;font-size:11.5px;font-weight:600;color:rgba(255,255,255,.55);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.login-input{width:100%;padding:13px 16px;border-radius:var(--r);border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;font-size:14px;font-family:inherit;transition:all var(--tr);backdrop-filter:blur(8px)}
.login-input::placeholder{color:rgba(255,255,255,.3)}
.login-input:focus{outline:none;border-color:var(--pr);box-shadow:0 0 0 3px rgba(19,112,94,.2);background:rgba(255,255,255,.1)}
.login-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.login-check{display:flex;align-items:center;gap:7px;font-size:12.5px;color:rgba(255,255,255,.5);cursor:pointer}
.login-check input{accent-color:var(--pr);width:15px;height:15px}
.login-forgot{font-size:12.5px;color:var(--pr);cursor:pointer;font-weight:500;text-decoration:none}
.login-btn{width:100%;padding:14px;border:none;border-radius:var(--r);background:linear-gradient(135deg,var(--pr),#2BA88A);color:#fff;font-size:14.5px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s ease;box-shadow:0 4px 20px rgba(19,112,94,.3)}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(19,112,94,.4)}
.login-btn.loading{pointer-events:none;opacity:.7}
.login-divider{display:flex;align-items:center;gap:12px;margin:24px 0;color:rgba(255,255,255,.25);font-size:11px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1)}
.login-sso{width:100%;padding:12px;border:1px solid rgba(255,255,255,.12);border-radius:var(--r);background:rgba(255,255,255,.04);color:rgba(255,255,255,.6);font-size:13px;font-weight:500;font-family:inherit;cursor:pointer;transition:all var(--tr);display:flex;align-items:center;justify-content:center;gap:8px}
.login-sso:hover{background:rgba(255,255,255,.08);color:#fff}
.login-footer{margin-top:40px;text-align:center;font-size:11.5px;color:rgba(255,255,255,.3);position:relative;z-index:1}
.login-error{background:rgba(204,61,74,.15);border:1px solid rgba(204,61,74,.3);border-radius:var(--rs);padding:10px 14px;margin-bottom:16px;font-size:12.5px;color:#ff8a95;display:none}
.login-error.show{display:block}
#appShell{display:none;height:100vh}#appShell.show{display:flex}
.app{display:flex;height:100vh;width:100%}
.sb{width:var(--sbw);background:var(--wh);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;z-index:100}
.sb-brand{height:var(--hdh);display:flex;align-items:center;gap:10px;padding:0 16px;border-bottom:1px solid var(--bd)}
.sb-logo{width:32px;height:32px;border-radius:7px;background:linear-gradient(135deg,var(--pr),#2BA88A);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:10px;color:#fff;letter-spacing:-.5px}
.sb-bx .n{font-weight:700;font-size:13.5px;letter-spacing:-.3px}.sb-bx .s{font-size:9.5px;color:var(--t3);font-weight:500;letter-spacing:.3px}
.sb-nav{flex:1;padding:12px 8px;overflow-y:auto}
.sb-g{margin-bottom:16px}.sb-gl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--t4);padding:0 8px;margin-bottom:5px;font-weight:700}
.sb-i{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:var(--rs);color:var(--t3);cursor:pointer;transition:all var(--tr);font-size:12.5px;font-weight:500}
.sb-i:hover{color:var(--tx);background:var(--s2)}.sb-i.act{color:var(--pr);background:var(--pl);font-weight:600}
.sb-i svg{width:17px;height:17px;flex-shrink:0;stroke-width:1.8}
.badge{margin-left:auto;font-size:9.5px;font-weight:700;padding:1px 6px;border-radius:9px}
.badge.g{background:var(--sl);color:var(--su)}.badge.o{background:var(--wl);color:var(--wr)}.badge.r{background:var(--dl);color:var(--dg)}.badge.b{background:var(--bll);color:var(--blu)}.badge.p{background:var(--pul);color:var(--pur)}
.sb-div{height:1px;background:var(--bl);margin:10px 8px}
.sb-ft{padding:10px 12px;border-top:1px solid var(--bd)}
.sb-user{display:flex;align-items:center;gap:8px;padding:5px;border-radius:var(--rs);cursor:pointer;transition:background var(--tr)}
.sb-user:hover{background:var(--s2)}
.sb-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--pr),#2BA88A);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:10px;color:#fff}
.sb-user .n{font-weight:600;font-size:12px}.sb-user .r{font-size:10px;color:var(--t3)}
.sb-logout{margin-top:8px;display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:var(--rs);color:var(--dg);cursor:pointer;font-size:11.5px;font-weight:500;transition:all var(--tr)}
.sb-logout:hover{background:var(--dl)}.sb-logout svg{width:15px;height:15px}
.mn{flex:1;display:flex;flex-direction:column;overflow:hidden}
.hd{height:var(--hdh);background:var(--wh);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0}
.hd-l{display:flex;align-items:center;gap:12px}
.hd-ic{width:34px;height:34px;border-radius:var(--rs);display:flex;align-items:center;justify-content:center}
.hd-ic svg{width:16px;height:16px;stroke-width:1.8}
.hd-t{font-weight:700;font-size:15px;letter-spacing:-.2px}.hd-d{font-size:11.5px;color:var(--t3);margin-top:1px}
.hd-r{display:flex;align-items:center;gap:8px}
.sch{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:0 10px;height:34px;width:220px;transition:all var(--tr);position:relative}
.sch:focus-within{border-color:var(--pr);box-shadow:0 0 0 3px rgba(19,112,94,.07);width:280px}
.sch svg{color:var(--t4);width:14px;height:14px;flex-shrink:0}.sch input{background:none;border:none;outline:none;color:var(--tx);font-size:12px;width:100%;font-family:inherit}.sch input::placeholder{color:var(--t4)}
.ib{width:34px;height:34px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--wh);color:var(--t3);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--tr);position:relative}
.ib:hover{background:var(--s2);color:var(--tx)}.ib .dot{position:absolute;top:6px;right:6px;width:6px;height:6px;background:var(--red);border-radius:50%;border:1.5px solid var(--wh)}
.em-st{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:5px 10px;border-radius:var(--rs);background:var(--sl);color:var(--su);border:1px solid rgba(19,112,94,.15);cursor:pointer}
.em-st svg{width:13px;height:13px}
.ct{flex:1;overflow-y:auto;padding:18px 20px 36px}
.pg{display:none;animation:pgIn .25s ease}.pg.act{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.cd{background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--sh)}
.cd-h{padding:12px 16px;border-bottom:1px solid var(--bl);display:flex;align-items:center;justify-content:space-between}
.cd-t{font-weight:600;font-size:13px;display:flex;align-items:center;gap:6px}.cd-t svg{width:14px;height:14px;color:var(--t3)}
.cd-a{font-size:11.5px;color:var(--pr);cursor:pointer;font-weight:600}.cd-a:hover{opacity:.7}
.cd-b{padding:16px}
.btn{display:inline-flex;align-items:center;gap:4px;padding:7px 14px;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--tr);font-family:inherit;border:none}
.btn svg{width:13px;height:13px}
.btn-p{background:var(--pr);color:#fff}.btn-p:hover{background:var(--ph);transform:translateY(-1px);box-shadow:0 3px 10px rgba(19,112,94,.18)}
.btn-o{background:transparent;color:var(--t2);border:1px solid var(--bd)}.btn-o:hover{background:var(--s2)}
.btn-o.act{background:var(--pl);color:var(--pr);border-color:var(--pr)}
.btn-d{background:var(--dl);color:var(--dg);border:1px solid transparent}.btn-d:hover{background:var(--red);color:#fff}
.btn-sm{padding:5px 10px;font-size:11px}
.btn:disabled{opacity:.4;pointer-events:none}
.btn-blu{background:var(--blu);color:#fff}.btn-blu:hover{background:#2952c4}
.st-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:18px}
.st{background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);padding:14px 16px;box-shadow:var(--sh);transition:all var(--tr)}.st:hover{box-shadow:var(--sh2);transform:translateY(-1px)}
.st-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.st-ic{width:32px;height:32px;border-radius:var(--rs);display:flex;align-items:center;justify-content:center}.st-ic svg{width:15px;height:15px}
.st-ch{font-size:10.5px;font-weight:600}.st-ch.up{color:var(--su)}.st-ch.dn{color:var(--dg)}
.st-v{font-size:22px;font-weight:800;letter-spacing:-.7px;margin-bottom:2px}.st-l{font-size:11px;color:var(--t3);font-weight:500}
.tb{width:100%;border-collapse:collapse}
.tb thead th{text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--t4);font-weight:600;padding:9px 12px;border-bottom:1px solid var(--bd);background:var(--s2)}
.tb tbody tr{border-bottom:1px solid var(--bl);transition:background var(--tr);cursor:pointer}.tb tbody tr:hover{background:var(--s2)}.tb tbody tr:last-child{border-bottom:none}
.tb tbody td{padding:10px 12px;font-size:12.5px}
.tg{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:10.5px;font-weight:600;gap:3px}
.tg.g{background:var(--sl);color:var(--su)}.tg.o{background:var(--wl);color:var(--wr)}.tg.r{background:var(--dl);color:var(--dg)}.tg.b{background:var(--bll);color:var(--blu)}.tg.p{background:var(--pul);color:var(--pur)}.tg.gd{background:var(--gll);color:var(--gld)}.tg.n{background:var(--s2);color:var(--t3)}
.tbr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.filter-group{display:flex;gap:6px;flex-wrap:wrap}
.ec{display:flex;align-items:center;gap:8px}
.ec-av{width:30px;height:30px;border-radius:7px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:10px;color:#fff}
.ec-n{font-weight:600;font-size:12.5px}.ec-s{font-size:10.5px;color:var(--t3)}
.lf-bar{display:flex;gap:2px;margin-bottom:18px;background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);padding:4px;box-shadow:var(--sh)}
.lf-s{flex:1;text-align:center;padding:10px 8px;border-radius:var(--rs);cursor:pointer;transition:all var(--tr);position:relative}
.lf-s:hover{background:var(--s2)}.lf-s.act{background:var(--pl)}
.lf-s .num{font-size:22px;font-weight:800;letter-spacing:-.5px;margin-bottom:1px}.lf-s .nm{font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.lf-s .bar{position:absolute;bottom:0;left:10%;right:10%;height:3px;border-radius:3px}
.lf-s:nth-child(1) .num{color:var(--t2)}.lf-s:nth-child(1) .bar{background:var(--t4)}
.lf-s:nth-child(2) .num{color:var(--blu)}.lf-s:nth-child(2) .bar{background:var(--blu)}
.lf-s:nth-child(3) .num{color:var(--org)}.lf-s:nth-child(3) .bar{background:var(--org)}
.lf-s:nth-child(4) .num{color:var(--pur)}.lf-s:nth-child(4) .bar{background:var(--pur)}
.lf-s:nth-child(5) .num{color:var(--pr)}.lf-s:nth-child(5) .bar{background:var(--pr)}
.lf-s:nth-child(6) .num{color:var(--t4)}.lf-s:nth-child(6) .bar{background:var(--t4)}
.ai-p{background:linear-gradient(135deg,#f0faf6,#eef3fd);border:1px solid var(--bd);border-radius:var(--r);padding:18px;margin-bottom:14px}
.ai-h{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.ai-dot{width:8px;height:8px;border-radius:50%;background:var(--pr);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.ai-tt{font-weight:700;font-size:13.5px;background:linear-gradient(135deg,var(--pr),var(--blu));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ai-cd{background:var(--wh);border:1px solid var(--bl);border-radius:var(--rs);padding:12px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px;transition:all var(--tr)}.ai-cd:hover{box-shadow:var(--sh2)}.ai-cd:last-child{margin-bottom:0}
.ai-ic{width:30px;height:30px;border-radius:var(--rs);display:flex;align-items:center;justify-content:center;flex-shrink:0}.ai-ic svg{width:14px;height:14px}
.em-i{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--bl);transition:background var(--tr)}
.em-i:last-child{border-bottom:none}.em-i:hover{background:var(--s2);margin:0 -16px;padding:10px 16px;border-radius:var(--rs)}
.dg{display:grid;grid-template-columns:3fr 2fr;gap:12px}
.dg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
.inv-g{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.inv-c{background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);padding:16px;box-shadow:var(--sh);transition:all var(--tr)}.inv-c:hover{box-shadow:var(--sh2);transform:translateY(-1px)}
.ch-a{height:180px;display:flex;align-items:flex-end;gap:4px;padding-bottom:18px;position:relative}
.cg{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.cbs{display:flex;gap:2px;align-items:flex-end;height:145px;width:100%}
.cb{flex:1;border-radius:3px 3px 0 0;transition:all .5s ease;min-height:2px;position:relative}.cb.a{background:var(--pr);opacity:.8}.cb.b{background:var(--blu);opacity:.45}.cb:hover{opacity:1}
.cb:hover::after{content:attr(data-val);position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:700;background:var(--tx);color:#fff;padding:2px 5px;border-radius:3px;white-space:nowrap}
.cl{font-size:9.5px;color:var(--t4)}
.ch-lg{position:absolute;top:0;right:0;display:flex;gap:10px;font-size:9.5px;color:var(--t3)}
.ch-lg span{display:flex;align-items:center;gap:3px}.ch-lg .dt{width:7px;height:7px;border-radius:2px}
.ai-i{display:flex;gap:9px;padding:8px 0;border-bottom:1px solid var(--bl)}.ai-i:last-child{border-bottom:none}
.ai-iic{width:26px;height:26px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center}.ai-iic svg{width:12px;height:12px}
.pipe{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px}
.pcol{min-width:200px;width:200px;flex-shrink:0;display:flex;flex-direction:column}
.phd{padding:9px 12px;border-radius:var(--r) var(--r) 0 0;background:var(--wh);border:1px solid var(--bd);border-bottom:none;display:flex;align-items:center;justify-content:space-between}
.phd h4{font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
.pcnt{width:18px;height:18px;border-radius:50%;font-size:9.5px;font-weight:700;display:flex;align-items:center;justify-content:center;background:var(--s2);color:var(--t3)}
.pbd{flex:1;background:var(--s2);border:1px solid var(--bd);border-top:none;border-radius:0 0 var(--r) var(--r);padding:6px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;min-height:120px}
.pbd.drag-over{background:var(--pl);border-color:var(--pr)}
.dl{background:var(--wh);border:1px solid var(--bd);border-radius:var(--rs);padding:10px;cursor:grab;transition:all var(--tr);user-select:none}.dl:hover{box-shadow:var(--sh2);transform:translateY(-1px)}
.dl.dragging{opacity:.4;transform:rotate(2deg)}
.dl-t{font-weight:600;font-size:12px;margin-bottom:3px}.dl-c{font-size:11px;color:var(--t3);margin-bottom:7px}
.dl-r{display:flex;align-items:center;justify-content:space-between}.dl-a{font-weight:700;font-size:13px;color:var(--pr)}.dl-d{font-size:10px;color:var(--t4)}
.pcol:nth-child(1) .phd{border-bottom:2px solid var(--blu)}.pcol:nth-child(2) .phd{border-bottom:2px solid var(--org)}.pcol:nth-child(3) .phd{border-bottom:2px solid var(--pur)}.pcol:nth-child(4) .phd{border-bottom:2px solid var(--pr)}.pcol:nth-child(5) .phd{border-bottom:2px solid var(--gld)}
.prog{height:6px;background:var(--s3);border-radius:9px;overflow:hidden}.prog-f{height:100%;border-radius:9px;transition:width .8s ease}
.kpi-b{margin-bottom:12px}.kpi-r{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px}
.fg{margin-bottom:13px}.fg label{display:block;font-size:10.5px;font-weight:600;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.fi{width:100%;padding:8px 11px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--wh);color:var(--tx);font-size:12px;font-family:inherit;transition:all var(--tr)}
.fi:focus{outline:none;border-color:var(--pr);box-shadow:0 0 0 3px rgba(19,112,94,.07)}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
textarea.fi{resize:vertical;min-height:60px}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bl)}.toggle-row:last-child{border-bottom:none}
.tog-i span:first-child{font-size:12px;font-weight:500;display:block}.tog-i span:last-child{font-size:10.5px;color:var(--t3)}
.tog{width:38px;height:20px;border-radius:10px;background:var(--s3);border:none;cursor:pointer;position:relative;transition:all var(--tr)}
.tog.on{background:var(--pr)}.tog::after{content:'';position:absolute;top:2.5px;left:2.5px;width:15px;height:15px;border-radius:50%;background:#fff;transition:transform var(--tr);box-shadow:0 1px 2px rgba(0,0,0,.12)}.tog.on::after{transform:translateX(18px)}
.set-g{display:grid;grid-template-columns:200px 1fr;gap:18px}
.set-ni{padding:8px 10px;border-radius:var(--rs);font-size:12px;font-weight:500;color:var(--t3);cursor:pointer;transition:all var(--tr);margin-bottom:2px}
.set-ni:hover{background:var(--s2);color:var(--tx)}.set-ni.act{background:var(--pl);color:var(--pr);font-weight:600}
.mo{position:fixed;inset:0;background:rgba(23,26,35,.35);backdrop-filter:blur(2px);z-index:1000;display:none;align-items:center;justify-content:center}.mo.show{display:flex}
.mo-box{background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);width:560px;max-width:92vw;max-height:82vh;overflow-y:auto;box-shadow:var(--sh3);animation:moIn .2s ease}
.mo-box.lg{width:720px}.mo-box.xl{width:880px}
@keyframes moIn{from{transform:translateY(12px);opacity:0}to{transform:none;opacity:1}}
.mo-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}.mo-h h2{font-size:14.5px;font-weight:700}
.mo-x{width:28px;height:28px;border-radius:var(--rs);border:1px solid var(--bd);background:transparent;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px}.mo-x:hover{background:var(--s2);color:var(--tx)}
.mo-b{padding:18px}.mo-f{padding:12px 18px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:6px}
.toast{position:fixed;bottom:18px;right:18px;z-index:2000;background:var(--wh);border:1px solid var(--bd);border-left:3px solid var(--pr);border-radius:var(--rs);padding:11px 16px;box-shadow:var(--sh3);transform:translateX(140%);transition:transform .3s ease;max-width:320px}
.toast.show{transform:none}.toast-t{font-weight:600;font-size:12px;margin-bottom:1px}.toast-m{font-size:11px;color:var(--t3)}
.toast.error{border-left-color:var(--dg)}.toast.warning{border-left-color:var(--org)}
.search-drop{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--sh3);max-height:320px;overflow-y:auto;z-index:500;display:none}
.search-drop.show{display:block}
.search-drop .sr-i{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:12px;transition:background var(--tr)}
.search-drop .sr-i:hover{background:var(--s2)}
.notif-drop{position:absolute;top:calc(100% + 8px);right:0;width:340px;background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--sh3);z-index:500;display:none}
.notif-drop.show{display:block}
.notif-drop .nd-h{padding:10px 14px;border-bottom:1px solid var(--bl);display:flex;justify-content:space-between;align-items:center}
.notif-drop .nd-h h4{font-size:13px;font-weight:700}.notif-drop .nd-h span{font-size:11px;color:var(--pr);cursor:pointer;font-weight:600}
.notif-drop .nd-i{padding:10px 14px;border-bottom:1px solid var(--bl);transition:background var(--tr);cursor:pointer;display:flex;gap:8px}
.notif-drop .nd-i:hover{background:var(--s2)}.notif-drop .nd-i:last-child{border-bottom:none}
.confirm-overlay{position:fixed;inset:0;background:rgba(23,26,35,.45);z-index:3000;display:none;align-items:center;justify-content:center}
.confirm-overlay.show{display:flex}
.confirm-box{background:var(--wh);border-radius:var(--r);padding:24px;width:400px;max-width:90vw;box-shadow:var(--sh3);text-align:center}
.confirm-box h3{font-size:15px;margin-bottom:6px}.confirm-box p{font-size:12.5px;color:var(--t3);margin-bottom:18px;line-height:1.5}
.confirm-box .cf-btns{display:flex;gap:8px;justify-content:center}
.gauge-wrap{position:relative;width:160px;height:80px;margin:0 auto 8px}
.gauge-bg{position:absolute;width:160px;height:80px;border-radius:80px 80px 0 0;background:var(--s3);overflow:hidden}
.gauge-fill{position:absolute;bottom:0;left:0;width:160px;height:80px;border-radius:80px 80px 0 0;background:linear-gradient(135deg,var(--pr),#2BA88A);transform-origin:bottom center;transition:transform 1s ease}
.gauge-cover{position:absolute;bottom:0;left:10px;width:140px;height:70px;border-radius:70px 70px 0 0;background:var(--wh)}
.gauge-val{position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:20px;font-weight:800;color:var(--pr)}
.gauge-label{text-align:center;font-size:10.5px;color:var(--t3);font-weight:600}
.txn-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bl);font-size:12px}
.txn-row:last-child{border-bottom:none}
.txn-in{color:var(--su);font-weight:700}.txn-out{color:var(--dg);font-weight:700}
.pers-card{background:var(--s2);border-radius:var(--rs);padding:10px;display:flex;align-items:center;gap:8px;margin-bottom:6px}
.pers-card .pers-av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:9px;color:#fff;flex-shrink:0}
.order-line{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:8px;padding:8px;background:var(--s2);border-radius:var(--rs)}
.order-line .line-total{font-weight:700;font-size:13px;color:var(--pr);text-align:right;padding:8px 0}
@media(max-width:1280px){.st-row{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.sb{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);z-index:200}.sb.open{transform:none}.st-row{grid-template-columns:1fr 1fr}}

/* ═══ DEAL PIPELINE v7: Split View + Score + Detail ═══ */
.pipe-wrap{display:grid;grid-template-columns:1fr 380px;gap:0;height:calc(100vh - 140px);overflow:hidden}
.pipe-wrap.no-detail{grid-template-columns:1fr}
.pipe-wrap.no-detail .deal-panel{display:none}
.pipe-main{overflow-x:auto;overflow-y:auto;padding-bottom:8px}
.pipe-stats{display:flex;gap:16px;padding:10px 0;font-size:12px;color:var(--t3)}
.pipe-stats strong{color:var(--tx);font-size:16px}
.pipe-stats .ps-item{text-align:center;padding:8px 16px;background:var(--wh);border-radius:var(--rs);border:1px solid var(--bd)}
.pcol{min-width:190px;width:190px}
.pcol-foot{padding:6px 10px;background:var(--wh);border:1px solid var(--bd);border-top:none;border-radius:0 0 var(--r) var(--r);font-size:10px;color:var(--t3);display:flex;justify-content:space-between}
.pcol-foot strong{color:var(--tx)}
.dl{position:relative;padding:10px 10px 8px}
.dl.sel{border-color:var(--pr);box-shadow:0 0 0 2px var(--pl)}
.dl-score{position:absolute;top:8px;right:8px;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff}
.dl-meta{display:flex;gap:6px;margin-top:5px;font-size:9.5px;color:var(--t4)}
.dl-meta span{display:flex;align-items:center;gap:2px}
/* Deal Detail Panel */
.deal-panel{background:var(--wh);border-left:1px solid var(--bd);overflow-y:auto;display:flex;flex-direction:column}
.dp-head{padding:16px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:var(--wh);z-index:2}
.dp-title{font-size:15px;font-weight:700;margin-bottom:4px}
.dp-sub{font-size:11px;color:var(--t3);display:flex;gap:12px;flex-wrap:wrap}
.dp-tags{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.dp-tag{font-size:10px;padding:2px 8px;border-radius:20px;font-weight:600}
.dp-tabs{display:flex;border-bottom:1px solid var(--bd);padding:0 16px}
.dp-tab{padding:10px 14px;font-size:12px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all var(--tr)}
.dp-tab.act{color:var(--pr);border-bottom-color:var(--pr)}
.dp-body{flex:1;padding:16px;overflow-y:auto}
/* Stage Tracker */
.stage-track{display:flex;gap:0;margin:12px 0}
.stage-step{flex:1;position:relative}
.stage-bar{height:6px;border-radius:3px;background:var(--s3);margin-bottom:2px;overflow:hidden;transition:all .3s}
.stage-bar.done{background:var(--pr)}
.stage-bar.current{background:linear-gradient(90deg,var(--pr) 60%,var(--s3) 60%)}
.stage-bar.warn{background:var(--org)}
.stage-lbl{font-size:8.5px;color:var(--t4);text-align:center}
.stage-lbl.done{color:var(--pr);font-weight:600}
.stage-lbl.current{color:var(--pr);font-weight:700}
/* Deal Score Ring */
.ds-ring{position:relative;width:90px;height:90px;margin:0 auto}
.ds-ring svg{transform:rotate(-90deg)}
.ds-ring-val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800}
.ds-factors{display:grid;gap:6px;margin-top:10px}
.ds-factor{display:flex;align-items:center;gap:8px;font-size:11px}
.ds-factor-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ds-factor-bar{flex:1;height:4px;background:var(--s3);border-radius:2px;overflow:hidden}
.ds-factor-fill{height:100%;border-radius:2px;transition:width .5s}
/* Guided Actions */
.ga-item{display:flex;gap:10px;padding:10px;border-radius:var(--rs);background:var(--s2);margin-bottom:6px;cursor:pointer;transition:all var(--tr)}
.ga-item:hover{background:var(--pl)}
.ga-icon{width:32px;height:32px;border-radius:50%;background:var(--bll);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px}
.ga-text{font-size:11.5px;color:var(--t2)}.ga-text strong{color:var(--tx)}
/* Activity Timeline */
.atl{position:relative;padding-left:20px}
.atl::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--s3)}
.atl-item{position:relative;padding:8px 12px;margin-bottom:8px;background:var(--s2);border-radius:var(--rs);font-size:11.5px}
.atl-item::before{content:'';position:absolute;left:-17px;top:12px;width:10px;height:10px;border-radius:50%;border:2px solid var(--wh);z-index:1}
.atl-item.note::before{background:var(--blu)}.atl-item.call::before{background:var(--su)}
.atl-item.email::before{background:var(--org)}.atl-item.task::before{background:var(--pur)}
.atl-item.purchase::before{background:var(--pr)}.atl-item.stage::before{background:var(--gld)}
.atl-date{font-size:10px;color:var(--t4);margin-bottom:2px}
.atl-by{font-size:10px;color:var(--t3);margin-top:2px}
/* Quick Action Bar */
.qa-bar{display:flex;gap:4px;margin-bottom:12px}
.qa-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 12px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--wh);cursor:pointer;transition:all var(--tr);font-size:9px;color:var(--t3);font-family:inherit;min-width:52px}
.qa-btn:hover{background:var(--pl);border-color:var(--pr);color:var(--pr)}
.qa-btn svg{width:18px;height:18px}
/* Deal insight card */
.di-card{padding:10px;background:var(--s2);border-radius:var(--rs);margin-bottom:8px;font-size:11.5px}
.di-card .di-label{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--t4);font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:4px}


/* ═══ CONTACT MGMT: Collapsible Sections ═══ */
.cd-section{border:1px solid var(--bd);border-radius:var(--r);margin-bottom:10px;overflow:hidden}
.cd-sec-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--wh);cursor:pointer;user-select:none;transition:background var(--tr)}
.cd-sec-head:hover{background:var(--s2)}
.cd-sec-head h5{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px}
.cd-sec-arrow{font-size:10px;color:var(--t4);transition:transform .2s}
.cd-section.open .cd-sec-arrow{transform:rotate(90deg)}
.cd-sec-body{display:none;padding:12px 14px;border-top:1px solid var(--bl)}
.cd-section.open .cd-sec-body{display:block}
/* ═══ DEAL: Priority Tags ═══ */
.deal-tags{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
.dtag{font-size:8.5px;padding:1px 6px;border-radius:3px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.dtag.urgent{background:var(--rl);color:var(--dg)}.dtag.big{background:var(--orl);color:var(--org)}.dtag.new{background:var(--bll);color:var(--blu)}
.dtag.hot{background:#FDE8E8;color:#B91C1C}.dtag.vip{background:var(--pul);color:var(--pur)}
/* ═══ DEAL: Search Bar ═══ */
.deal-search{display:flex;gap:6px;align-items:center}
.deal-search input{padding:6px 12px;border:1px solid var(--bd);border-radius:var(--rs);font-family:inherit;font-size:12px;width:200px;background:var(--wh);transition:border var(--tr)}
.deal-search input:focus{border-color:var(--pr);outline:none}
/* ═══ DEAL: Weighted Pipeline ═══ */
.pipe-stat-grid{display:flex;gap:8px}
.ps-card{padding:10px 16px;background:var(--wh);border:1px solid var(--bd);border-radius:var(--rs);text-align:center;min-width:120px}
.ps-card .ps-val{font-size:18px;font-weight:800;color:var(--tx);line-height:1.2}
.ps-card .ps-label{font-size:10px;color:var(--t3);margin-top:2px}
/* ═══ CONTACT: Associated Deals in detail ═══ */
.assoc-deal{padding:8px 10px;background:var(--s2);border-radius:var(--rs);margin-bottom:6px;cursor:pointer;transition:all var(--tr);display:flex;justify-content:space-between;align-items:center}
.assoc-deal:hover{background:var(--pl);border-color:var(--pr)}
.assoc-deal .ad-name{font-weight:600;font-size:11.5px}.assoc-deal .ad-amt{font-weight:700;color:var(--pr);font-size:11.5px}
.assoc-deal .ad-meta{font-size:10px;color:var(--t3)}
/* ═══ CONTACT: Quick Create Deal bar ═══ */
.qcd-bar{display:flex;gap:8px;align-items:center;padding:10px 14px;background:var(--bll);border-radius:var(--rs);margin-bottom:12px;font-size:12px}
.qcd-bar .fi{flex:1;margin:0;font-size:12px}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-left">
    <div class="login-brand"><div class="login-logo">re:H</div><h1>re:H Master CRM</h1><p>JNA Corporation — Thailand Distribution Platform</p></div>
    <div class="login-form">
      <div class="login-error" id="loginError">Invalid ID or password.</div>
      <div class="fg"><label>ID</label><input class="login-input" type="text" id="loginEmail" placeholder="Enter your ID"></div>
      <div class="fg"><label>Password</label><input class="login-input" type="password" id="loginPass" placeholder="Enter your password"></div>
      <div class="login-row"><label class="login-check"><input type="checkbox" checked> Remember me</label><a class="login-forgot" href="#" onclick="showToast('Password Reset','Check your email');return false">Forgot password?</a></div>
      <button class="login-btn" id="loginBtn" onclick="handleLogin()">Sign In to CRM</button>
      <div class="login-divider">or continue with</div>
      <button class="login-sso" onclick="handleLogin()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>Single Sign-On (JNA SSO)</button>
    </div>
    <div class="login-footer">re:H Master CRM v6.0 — © 2026 JNA Corporation</div>
  </div>
</div>

<!-- APP -->
<div id="appShell"><div class="app">
<div class="sb">
  <div class="sb-brand"><div class="sb-logo">re:H</div><div class="sb-bx"><div class="n">re:H CRM</div><div class="s">JNA CORPORATION</div></div></div>
  <div class="sb-nav">
    <div class="sb-g"><div class="sb-gl">Overview</div>
      <div class="sb-i act" data-pg="dash"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>Dashboard</div>
      <div class="sb-i" data-pg="inbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 6l-10 7L2 6"/><path d="M2 6h20v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>Email Inbox<span class="badge b" id="inboxBadge">0</span></div>
    </div>
    <div class="sb-g"><div class="sb-gl">CRM</div>
      <div class="sb-i" data-pg="lifecycle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Clinic Lifecycle</div>
      <div class="sb-i" data-pg="targets"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>Target Clinics<span class="badge o" id="targetBadge">0</span></div>
    </div>
    <div class="sb-g"><div class="sb-gl">Operations</div>
      <div class="sb-i" data-pg="orders"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>Orders & Pipeline</div>
      <div class="sb-i" data-pg="inventory"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>Inventory</div>
      <div class="sb-i" data-pg="service"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>After-Sales<span class="badge r" id="svcBadge">0</span></div>
    </div>
    <div class="sb-div"></div>
    <div class="sb-g">
      <div class="sb-i" data-pg="ai"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>AI Agents</div>
      <div class="sb-i" data-pg="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</div>
    </div>
  </div>
  <div class="sb-ft">
    <div class="sb-user"><div class="sb-av" id="userAv">JK</div><div><div class="n" id="userName">Jun Kang</div><div class="r" id="userRole">Administrator</div></div></div>
    <div class="sb-logout" onclick="handleLogout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>Sign Out</div>
  </div>
</div>

<div class="mn">
  <div class="hd">
    <div class="hd-l"><div class="hd-ic" style="background:var(--pl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--pr)" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg></div><div><div class="hd-t" id="pgT">Dashboard</div><div class="hd-d" id="pgD">re:H distribution overview</div></div></div>
    <div class="hd-r">
      <div class="sch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg><input placeholder="Search… (Ctrl+K)" id="gSearch"><div class="search-drop" id="searchDrop"></div></div>
      <div class="em-st" onclick="openMo('emailInfo')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 6l-10 7L2 6"/><path d="M2 6h20v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg><span>sales@jnacorporation.com</span></div>
      <div class="ib" id="notifBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg><div class="dot" id="notifDot" style="display:none"></div><div class="notif-drop" id="notifDrop"></div></div>
    </div>
  </div>
  <div class="ct">

<!-- DASHBOARD -->
<div class="pg act" id="pg-dash">
  <div class="st-row" id="dashStats"></div>
  <div class="dg">
    <div class="cd"><div class="cd-h"><div class="cd-t">Revenue Chart</div><div class="cd-a" onclick="exportDashCSV()">↓ Export CSV</div></div><div class="cd-b"><div class="ch-a" id="mainChart"></div></div></div>
    <div>
      <div class="cd" style="margin-bottom:12px"><div class="cd-h"><div class="cd-t">Coverage Goal</div></div><div class="cd-b" style="text-align:center" id="gaugeArea"></div></div>
      <div class="cd"><div class="cd-h"><div class="cd-t">AI Insights</div></div><div class="cd-b" id="aiInsights"></div></div>
    </div>
  </div>
  <div class="dg3">
    <div class="cd"><div class="cd-h"><div class="cd-t">Recent Activity</div></div><div class="cd-b" style="padding:8px 16px" id="actFeed"></div></div>
    <div class="cd"><div class="cd-h"><div class="cd-t">Inventory</div><div class="cd-a" onclick="navTo('inventory')">Manage →</div></div><div class="cd-b" id="invStatus"></div></div>
    <div class="cd"><div class="cd-h"><div class="cd-t">Pipeline</div><div class="cd-a" onclick="navTo('orders')">View →</div></div><div class="cd-b" id="pipeSummary"></div></div>
  </div>
</div>

<!-- EMAIL -->
<div class="pg" id="pg-inbox">
  <div class="ai-p"><div class="ai-h"><div class="ai-dot"></div><div class="ai-tt">AI Email Agent — Active</div></div><div style="font-size:12px;color:var(--t2)">Connected: <strong>sales@jnacorporation.com</strong></div></div>
  <div class="tbr"><div class="filter-group" id="emailFilters"></div><button class="btn btn-p" onclick="simulateNewEmail()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/></svg>Sync Now</button></div>
  <div class="cd"><div class="cd-b" style="padding:8px 16px" id="emailList"></div></div>
</div>

<!-- CLINIC LIFECYCLE (merged Lifecycle + Portfolio) -->
<div class="pg" id="pg-lifecycle">
  <div class="lf-bar" id="lfBar"></div>
  <div class="tbr"><div class="filter-group" id="lfFilters"></div><div style="display:flex;gap:6px"><button class="btn btn-o" onclick="openMo('editBranch')">Edit Branch Info</button><button class="btn btn-p" onclick="openMo('addRecord')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Add Clinic</button></div></div>
  <div class="cd" style="overflow-x:auto"><table class="tb"><thead><tr><th>Clinic / Branch</th><th>Contact</th><th>Region</th><th>Stage</th><th style="min-width:60px">Health</th><th>First Purchase</th><th>Last Order</th><th>Reorder</th><th>Devices</th><th>Total Spend</th><th>Actions</th></tr></thead><tbody id="lfTable"></tbody></table></div>
</div>

<!-- TARGET CLINICS -->
<div class="pg" id="pg-targets">
  <div class="tbr"><div class="filter-group" id="targetFilters"></div><button class="btn btn-p" onclick="openMo('addTarget')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Add Target Clinic</button></div>
  <div style="display:grid;grid-template-columns:1fr 2fr;gap:14px">
    <div class="cd"><div class="cd-h"><div class="cd-t">Coverage Funnel</div></div><div class="cd-b" id="targetFunnel"></div></div>
    <div class="cd"><table class="tb"><thead><tr><th>Clinic</th><th>Contact</th><th>Region</th><th>Status</th><th>First Contact</th><th>Demo Date</th><th>Follow-up</th><th>Actions</th></tr></thead><tbody id="targetTable"></tbody></table></div>
  </div>
</div>

<!-- ORDERS & PIPELINE (HubSpot-inspired) -->
<div class="pg" id="pg-orders">
  <div class="tbr" style="flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:12px;flex:1;flex-wrap:wrap">
      <div class="filter-group" id="pipeFilters"></div>
      <div class="deal-search"><input type="text" id="dealSearchInput" placeholder="Search deals..." oninput="filterDeals(this.value)"></div>
    </div>
    <div style="display:flex;gap:6px">
      <button class="btn btn-o" id="pipeViewToggle" onclick="togglePipeView()">☰ List</button>
      <button class="btn btn-p" onclick="openMo('addOrder')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>New Deal</button>
    </div>
  </div>
  <div class="pipe-stats" id="pipeStats" style="margin-bottom:8px"></div>
  <div class="pipe-wrap" id="pipeWrap">
    <div class="pipe-main">
      <div class="pipe" id="pipeline"></div>
      <div id="dealListView" style="display:none"></div>
    </div>
    <div class="deal-panel" id="dealPanel">
      <div style="padding:40px;text-align:center;color:var(--t4);font-size:12px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:40px;height:40px;margin-bottom:8px;opacity:.3"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        <div>Select a deal to view details</div>
      </div>
    </div>
  </div>
  <div style="margin-top:12px"><div class="cd"><div class="cd-h"><div class="cd-t">Purchase History</div><div class="cd-a" onclick="exportPurchaseCSV()">↓ Export</div></div><table class="tb"><thead><tr><th>Date</th><th>Clinic</th><th>Items</th><th>Total</th><th>Payment</th><th>Notes</th></tr></thead><tbody id="purchaseTable"></tbody></table></div></div>
</div>

<!-- INVENTORY -->
<div class="pg" id="pg-inventory">
  <div class="tbr"><div class="filter-group" id="invFilters"></div><div style="display:flex;gap:6px"><button class="btn btn-p" onclick="openInvIn()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Record Import</button><button class="btn btn-blu" onclick="openInvOut()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>Record Sale</button></div></div>
  <div class="inv-g" id="invGrid"></div>
  <div style="margin-top:16px"><div class="cd"><div class="cd-h"><div class="cd-t">Transaction History</div></div><div class="cd-b" style="padding:8px 16px;max-height:300px;overflow-y:auto" id="invHistory"></div></div></div>
</div>

<!-- SERVICE -->
<div class="pg" id="pg-service">
  <div class="tbr"><div class="filter-group" id="svcFilters"></div><button class="btn btn-p" onclick="openMo('addTicket')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>New Ticket</button></div>
  <div class="cd"><table class="tb"><thead><tr><th>Ticket</th><th>Clinic</th><th>Category</th><th>Issue</th><th>Priority</th><th>Status</th><th>SLA</th><th>Actions</th></tr></thead><tbody id="svcTable"></tbody></table></div>
</div>

<!-- AI AGENTS -->
<div class="pg" id="pg-ai">
  <div class="ai-p"><div class="ai-h"><div class="ai-dot"></div><div class="ai-tt">AI Automation Hub — 6 Active Agents</div></div><div style="font-size:12px;color:var(--t2)">Agents monitor sales@jnacorporation.com, clinic data, inventory.</div></div>
  <div class="inv-g" id="aiGrid"></div>
</div>

<!-- SETTINGS -->
<div class="pg" id="pg-settings"><div class="set-g"><div id="setNav"></div><div id="setPanels"></div></div></div>

</div></div></div></div>

<!-- ═══════════════ MODALS ═══════════════ -->
<!-- Add Lifecycle Record -->
<div class="mo" id="mo-addRecord"><div class="mo-box lg"><div class="mo-h"><h2>Add Clinic Record</h2><button class="mo-x" onclick="closeMo('addRecord')">×</button></div><div class="mo-b">
  <div style="font-size:10px;font-weight:600;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">① Clinic Information</div>
  <div class="fr"><div class="fg"><label>Clinic Name *</label><input class="fi" id="arName" required></div><div class="fg"><label>Branch</label><input class="fi" id="arBranch" placeholder="e.g. Sukhumvit"></div></div>
  <div class="fr"><div class="fg"><label>Contact Person *</label><input class="fi" id="arContact" required></div><div class="fg"><label>Email</label><input class="fi" id="arEmail" type="email"></div></div>
  <div class="fr"><div class="fg"><label>Phone</label><input class="fi" id="arPhone"></div><div class="fg"><label>Region</label><select class="fi" id="arRegion"><option>Bangkok</option><option>Chiang Mai</option><option>Phuket</option><option>Pattaya</option><option>Hat Yai</option><option>Khon Kaen</option><option>Udon Thani</option><option>Other</option></select></div></div>
  <div class="fr"><div class="fg"><label>Stage</label><select class="fi" id="arStage"><option value="enquiry">Enquiry</option><option value="waiting">Waiting</option><option value="installing">Installing</option><option value="active">Active</option><option value="churned">Churned</option></select></div><div class="fg"><label>Source</label><select class="fi" id="arSource"><option>Email</option><option>Phone Call</option><option>Walk-in</option><option>Expo / Event</option><option>Referral</option><option>Target Pool</option></select></div></div>
  <div style="height:1px;background:var(--bd);margin:14px 0"></div>
  <div style="font-size:10px;font-weight:600;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">② Initial Purchase Package <span style="font-weight:400;text-transform:none;letter-spacing:0">(leave blank if enquiry only)</span></div>
  <div class="fr"><div class="fg"><label>First Purchase Date</label><input class="fi" type="date" id="arFirstPurchase"></div><div class="fg"><label>Contract Type</label><select class="fi" id="arContract"><option value="">— Select —</option><option value="outright">Outright Purchase</option><option value="lease">Lease / Rental</option><option value="installment">Installment Plan</option><option value="consignment">Consignment</option></select></div></div>
  <div style="font-size:10.5px;font-weight:600;color:var(--t2);margin-bottom:6px">Package Items <span style="font-weight:400;color:var(--t4)">(set each clinic's agreed price)</span>:</div>
  <div style="display:grid;grid-template-columns:3fr 1fr 1.2fr 1fr;gap:6px;margin-bottom:4px;font-size:9px;color:var(--t4);text-transform:uppercase;padding:0 4px"><span>Product</span><span>Qty</span><span>Agreed Price (฿)</span><span>Subtotal</span></div>
  <div style="display:grid;grid-template-columns:3fr 1fr 1.2fr 1fr;gap:6px;margin-bottom:6px;align-items:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-size:12px;font-weight:600">re:H Device</span><input class="fi" type="number" id="arPkgDev" value="0" min="0" style="text-align:center" oninput="calcPkgTotal()"><input class="fi" type="number" id="arPriceDev" value="500000" min="0" style="text-align:right" oninput="calcPkgTotal()"><span class="ar-sub" style="font-size:11px;font-weight:600;color:var(--pr)">฿0</span></div>
  <div style="display:grid;grid-template-columns:3fr 1fr 1.2fr 1fr;gap:6px;margin-bottom:6px;align-items:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-size:12px;font-weight:600;color:var(--blu)">Balloon</span><input class="fi" type="number" id="arPkgBalloon" value="0" min="0" style="text-align:center" oninput="calcPkgTotal()"><input class="fi" type="number" id="arPriceBalloon" value="11000" min="0" style="text-align:right" oninput="calcPkgTotal()"><span class="ar-sub" style="font-size:11px;font-weight:600;color:var(--pr)">฿0</span></div>
  <div style="display:grid;grid-template-columns:3fr 1fr 1.2fr 1fr;gap:6px;margin-bottom:6px;align-items:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-size:12px;font-weight:600;color:var(--pur)">Pink</span><input class="fi" type="number" id="arPkgPink" value="0" min="0" style="text-align:center" oninput="calcPkgTotal()"><input class="fi" type="number" id="arPricePink" value="9000" min="0" style="text-align:right" oninput="calcPkgTotal()"><span class="ar-sub" style="font-size:11px;font-weight:600;color:var(--pr)">฿0</span></div>
  <div style="display:grid;grid-template-columns:3fr 1fr 1.2fr 1fr;gap:6px;margin-bottom:6px;align-items:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-size:12px;font-weight:600;color:var(--gld)">Toning</span><input class="fi" type="number" id="arPkgToning" value="0" min="0" style="text-align:center" oninput="calcPkgTotal()"><input class="fi" type="number" id="arPriceToning" value="4500" min="0" style="text-align:right" oninput="calcPkgTotal()"><span class="ar-sub" style="font-size:11px;font-weight:600;color:var(--pr)">฿0</span></div>
  <div id="arPkgTotal" style="text-align:right;font-size:13px;font-weight:700;color:var(--pr);padding:8px;background:var(--pl);border-radius:var(--rs);margin-bottom:12px">Package Total: ฿0</div>
  <div class="fr"><div class="fg"><label>Warranty Start</label><input class="fi" type="date" id="arWarranty"></div><div class="fg"><label>Expected Reorder Cycle (days)</label><input class="fi" type="number" id="arReorderCycle" value="90" min="0" placeholder="e.g. 90"></div></div>
  <div class="fg"><label>Notes</label><textarea class="fi" id="arNotes" rows="2" placeholder="Initial remarks, special agreements, etc."></textarea></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('addRecord')">Cancel</button><button class="btn btn-p" onclick="saveRecord()">Save Record</button></div></div></div>

<!-- Edit Branch Info -->
<div class="mo" id="mo-editBranch"><div class="mo-box"><div class="mo-h"><h2>Edit Branch Details</h2><button class="mo-x" onclick="closeMo('editBranch')">×</button></div><div class="mo-b">
  <div class="fg"><label>Select Clinic</label><select class="fi" id="ebClinic" onchange="loadBranchEdit(this.value)"></select></div>
  <div id="ebFields" style="display:none">
    <div class="fr"><div class="fg"><label>Tier</label><select class="fi" id="ebTier"><option>Premium</option><option selected>Standard</option><option>Starter</option></select></div><div class="fg"><label>Monthly KPI Target (฿)</label><input class="fi" type="number" id="ebKPI" value="130000"></div></div>
    <div class="fr"><div class="fg"><label>Installation Date</label><input class="fi" type="date" id="ebInst"></div><div class="fg"><label>Devices Deployed</label><input class="fi" type="number" id="ebDev" value="0" min="0"></div></div>
    <div class="fr"><div class="fg"><label>Total Spend (฿)</label><input class="fi" type="number" id="ebSpend" value="0"></div><div class="fg"><label>Avg Monthly (฿)</label><input class="fi" type="number" id="ebAvg" value="0"></div></div>
  </div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('editBranch')">Cancel</button><button class="btn btn-p" onclick="saveBranchEdit()">Save Changes</button></div></div></div>

<!-- Clinic Detail (portfolio view) -->
<div class="mo" id="mo-clinicDetail"><div class="mo-box xl"><div class="mo-h"><h2 id="cdTitle">Clinic Detail</h2><button class="mo-x" onclick="closeMo('clinicDetail')">×</button></div><div class="mo-b" id="cdBody"></div></div></div>

<!-- Add Personnel -->
<div class="mo" id="mo-addPerson"><div class="mo-box"><div class="mo-h"><h2>Add Personnel</h2><button class="mo-x" onclick="closeMo('addPerson')">×</button></div><div class="mo-b">
  <input type="hidden" id="apClinicId">
  <div class="fr"><div class="fg"><label>Name *</label><input class="fi" id="apName"></div><div class="fg"><label>Role</label><select class="fi" id="apRole"><option>Doctor</option><option>Sales</option><option>Marketing</option><option>Management</option><option>Nurse</option><option>Receptionist</option></select></div></div>
  <div class="fr"><div class="fg"><label>Phone</label><input class="fi" id="apPhone"></div><div class="fg"><label>Email</label><input class="fi" id="apEmail" type="email"></div></div>
  <div class="fg"><label>Specialty / Notes</label><input class="fi" id="apNotes"></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('addPerson')">Cancel</button><button class="btn btn-p" onclick="savePersonnel()">Add</button></div></div></div>

<!-- Add Target -->
<div class="mo" id="mo-addTarget"><div class="mo-box"><div class="mo-h"><h2>Add Target Clinic</h2><button class="mo-x" onclick="closeMo('addTarget')">×</button></div><div class="mo-b">
  <div class="fr"><div class="fg"><label>Clinic Name *</label><input class="fi" id="tgName"></div><div class="fg"><label>Contact Person</label><input class="fi" id="tgContact"></div></div>
  <div class="fr"><div class="fg"><label>Phone</label><input class="fi" id="tgPhone"></div><div class="fg"><label>Region</label><select class="fi" id="tgRegion"><option>Bangkok</option><option>Chiang Mai</option><option>Phuket</option><option>Pattaya</option><option>Hat Yai</option><option>Khon Kaen</option><option>Udon Thani</option><option>Other</option></select></div></div>
  <div class="fr"><div class="fg"><label>Status</label><select class="fi" id="tgStatus"><option value="not_approached">Not Yet Approached</option><option value="contacted">Contacted</option><option value="waiting">Waiting for Feedback</option></select></div><div class="fg"><label>First Contacted Date</label><input class="fi" type="date" id="tgFirstContact"></div></div>
  <div class="fr"><div class="fg"><label>Demonstration Date</label><input class="fi" type="date" id="tgDemoDate"></div><div class="fg"><label>Email</label><input class="fi" id="tgEmail" type="email" placeholder="For follow-up emails"></div></div>
  <div class="fg"><label>Notes</label><textarea class="fi" id="tgNotes"></textarea></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('addTarget')">Cancel</button><button class="btn btn-p" onclick="saveTarget()">Add Target</button></div></div></div>

<!-- Edit Target -->
<div class="mo" id="mo-editTarget"><div class="mo-box"><div class="mo-h"><h2>Edit Target</h2><button class="mo-x" onclick="closeMo('editTarget')">×</button></div><div class="mo-b">
  <input type="hidden" id="etIdx">
  <div class="fr"><div class="fg"><label>First Contacted</label><input class="fi" type="date" id="etFirstContact"></div><div class="fg"><label>Demonstration Date</label><input class="fi" type="date" id="etDemoDate"></div></div>
  <div class="fr"><div class="fg"><label>Email</label><input class="fi" id="etEmail" type="email"></div><div class="fg"><label>Status</label><select class="fi" id="etStatus"><option value="not_approached">Not Approached</option><option value="contacted">Contacted</option><option value="waiting">Waiting</option><option value="converted">Converted</option></select></div></div>
  <div class="fg"><label>Notes</label><textarea class="fi" id="etNotes"></textarea></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('editTarget')">Cancel</button><button class="btn btn-p" onclick="saveEditTarget()">Save</button></div></div></div>

<!-- Record Purchase (dynamically populated with clinic's agreed prices) -->
<div class="mo" id="mo-recordPurchase"><div class="mo-box lg"><div class="mo-h"><h2 id="rpTitle">Record Purchase</h2><button class="mo-x" onclick="closeMo('recordPurchase')">×</button></div><div class="mo-b">
  <input type="hidden" id="rpClinicId">
  <div id="rpProductGrid"></div>
  <div style="text-align:right;padding:10px;background:var(--pl);border-radius:var(--rs);margin:10px 0"><span style="font-size:12px;color:var(--t3)">TOTAL:</span> <strong style="font-size:20px;color:var(--pr)" id="rpTotal">฿0</strong></div>
  <div class="fr"><div class="fg"><label>Date</label><input class="fi" type="date" id="rpDate"></div><div class="fg"><label>Payment</label><select class="fi" id="rpPayment"><option>Bank Transfer</option><option>Cash</option><option>Credit Card</option><option>Installment</option><option>Check</option></select></div></div>
  <div class="fg"><label>Notes</label><input class="fi" id="rpNotes" placeholder="e.g. Monthly reorder, special discount, etc."></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('recordPurchase')">Cancel</button><button class="btn btn-p" onclick="saveRepurchase()">Record Purchase</button></div></div></div>


<!-- Log Activity -->
<div class="mo" id="mo-logActivity"><div class="mo-box"><div class="mo-h"><h2 id="laTitle">Log Activity</h2><button class="mo-x" onclick="closeMo('logActivity')">×</button></div><div class="mo-b">
  <input type="hidden" id="laClinicId">
  <div class="fr"><div class="fg"><label>Type</label><select class="fi" id="laType" onchange="document.getElementById('laIcon').textContent={'note':'📝','call':'📞','email':'✉️','task':'📋','meeting':'🤝'}[this.value]||'📝'"><option value="note">Note</option><option value="call">Call</option><option value="email">Email</option><option value="task">Task</option><option value="meeting">Meeting</option></select></div><div class="fg"><label>Date</label><input class="fi" type="date" id="laDate"></div></div>
  <div class="fg"><label>Subject</label><input class="fi" id="laSubject" placeholder="Brief subject..."></div>
  <div class="fg"><label>Details</label><textarea class="fi" id="laBody" rows="4" placeholder="Activity details..."></textarea></div>
  <div class="fg"><label>Outcome / Status</label><select class="fi" id="laOutcome"><option value="">— None —</option><option value="completed">Completed</option><option value="follow-up needed">Follow-up Needed</option><option value="no answer">No Answer</option><option value="left voicemail">Left Voicemail</option><option value="interested">Interested</option><option value="not interested">Not Interested</option></select></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('logActivity')">Cancel</button><button class="btn btn-p" onclick="saveActivity()"><span id="laIcon">📝</span> Save Activity</button></div></div></div>

<!-- New Order (auto-calculate) -->
<div class="mo" id="mo-addOrder"><div class="mo-box lg"><div class="mo-h"><h2>New Order</h2><button class="mo-x" onclick="closeMo('addOrder')">×</button></div><div class="mo-b">
  <div class="fg"><label>Clinic *</label><select class="fi" id="aoClinic" onchange="onOrderClinicChange()"></select></div>
  <div id="aoPriceNote" style="display:none;padding:8px 12px;background:var(--bll);border-radius:var(--rs);margin-bottom:10px;font-size:11px;color:var(--blu)"></div>
  <div id="aoItems"></div>
  <button type="button" class="btn btn-sm btn-o" onclick="addOrderLine()" style="margin-bottom:12px">+ Add Item</button>
  <div style="text-align:right;padding:12px;background:var(--pl);border-radius:var(--rs);margin-bottom:12px"><span style="font-size:12px;color:var(--t3)">ORDER TOTAL:</span> <strong style="font-size:20px;color:var(--pr)" id="aoTotal">฿0</strong></div>
  <div class="fr"><div class="fg"><label>Stage</label><select class="fi" id="aoStage"><option>Enquiry</option><option>Demo</option><option>Proposal</option><option>Negotiation</option><option>Purchased</option></select></div><div class="fg"><label>Payment Method</label><select class="fi" id="aoPayment"><option>Bank Transfer</option><option>Cash</option><option>Credit Card</option><option>Installment</option><option>Check</option></select></div></div>
  <div class="fr"><div class="fg"><label>Close Date (Expected)</label><input class="fi" type="date" id="aoCloseDate"></div><div class="fg"><label>Priority</label><select class="fi" id="aoPriority"><option value="">— None —</option><option value="urgent">🔴 Urgent</option><option value="hot">🔥 Hot Deal</option><option value="big">💰 Big Customer</option><option value="vip">⭐ VIP</option><option value="new">🆕 New</option></select></div></div>
  <div class="fr"><div class="fg"><label>Date Created</label><input class="fi" type="date" id="aoDate"></div><div class="fg"><label>Notes / Next Activity</label><input class="fi" id="aoNotes" placeholder="e.g. Follow up call scheduled..."></div></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('addOrder')">Cancel</button><button class="btn btn-p" onclick="saveOrder()">Create Order</button></div></div></div>

<!-- Inventory modals (NO form tags — pure onclick) -->
<div class="mo" id="mo-invIn"><div class="mo-box"><div class="mo-h"><h2>Record Import / Purchase</h2><button class="mo-x" onclick="closeMo('invIn')">×</button></div><div class="mo-b">
  <div class="fr"><div class="fg"><label>Product *</label><select class="fi" id="iiProduct"></select></div><div class="fg"><label>Quantity *</label><input class="fi" type="number" id="iiQty" min="1" value="1"></div></div>
  <div class="fr"><div class="fg"><label>Cost per Unit (฿)</label><input class="fi" type="number" id="iiCost"></div><div class="fg"><label>Date</label><input class="fi" type="date" id="iiDate"></div></div>
  <div class="fg"><label>Supplier / PO#</label><input class="fi" id="iiNote" placeholder="e.g. PO-2026-001"></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('invIn')">Cancel</button><button class="btn btn-p" onclick="saveInvIn()">Record Import</button></div></div></div>

<div class="mo" id="mo-invOut"><div class="mo-box"><div class="mo-h"><h2>Record Sale / Outgoing</h2><button class="mo-x" onclick="closeMo('invOut')">×</button></div><div class="mo-b">
  <div class="fr"><div class="fg"><label>Product *</label><select class="fi" id="ioProduct"></select></div><div class="fg"><label>Quantity *</label><input class="fi" type="number" id="ioQty" min="1" value="1"></div></div>
  <div class="fr"><div class="fg"><label>Sell Price per Unit (฿)</label><input class="fi" type="number" id="ioPrice"></div><div class="fg"><label>Clinic</label><select class="fi" id="ioClinic"></select></div></div>
  <div class="fr"><div class="fg"><label>Date</label><input class="fi" type="date" id="ioDate"></div><div class="fg"><label>Invoice #</label><input class="fi" id="ioNote"></div></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('invOut')">Cancel</button><button class="btn btn-blu" onclick="saveInvOut()">Record Sale</button></div></div></div>

<div class="mo" id="mo-editProduct"><div class="mo-box"><div class="mo-h"><h2 id="epTitle">Edit Product</h2><button class="mo-x" onclick="closeMo('editProduct')">×</button></div><div class="mo-b">
  <input type="hidden" id="epIdx">
  <div class="fr"><div class="fg"><label>Product Name</label><input class="fi" id="epName"></div><div class="fg"><label>Description</label><input class="fi" id="epDesc"></div></div>
  <div class="fr"><div class="fg"><label>Cost Price (฿)</label><input class="fi" type="number" id="epCost"></div><div class="fg"><label>Sell Price (฿)</label><input class="fi" type="number" id="epSell"></div></div>
  <div class="fg"><label>Reorder Level</label><input class="fi" type="number" id="epReorder"></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('editProduct')">Cancel</button><button class="btn btn-p" onclick="saveProductEdit()">Save</button></div></div></div>

<!-- Service Ticket -->
<div class="mo" id="mo-addTicket"><div class="mo-box"><div class="mo-h"><h2>New Service Ticket</h2><button class="mo-x" onclick="closeMo('addTicket')">×</button></div><div class="mo-b">
  <div class="fr"><div class="fg"><label>Clinic *</label><select class="fi" id="atClinic"></select></div><div class="fg"><label>Device S/N</label><input class="fi" id="atDevice" placeholder="re:H #RF-XXXX"></div></div>
  <div class="fg"><label>Issue Category *</label><select class="fi" id="atCategory" onchange="prefillIssue(this.value)">
    <option value="">— Select common issue —</option>
    <option value="Device not powering on">Device not powering on</option>
    <option value="RF energy inconsistency / weak output">RF energy inconsistency / weak output</option>
    <option value="Cartridge not connecting / not recognized">Cartridge not connecting / not recognized</option>
    <option value="Error code displayed on screen">Error code displayed on screen</option>
    <option value="Screen malfunction / display issue">Screen malfunction / display issue</option>
    <option value="Needle depth calibration issue">Needle depth calibration issue</option>
    <option value="Overheating during operation">Overheating during operation</option>
    <option value="Preventive maintenance request">Preventive maintenance request</option>
    <option value="Warranty claim">Warranty claim</option>
    <option value="Training request for new staff">Training request for new staff</option>
    <option value="Replacement parts needed">Replacement parts needed</option>
    <option value="Software / firmware update needed">Software / firmware update needed</option>
    <option value="Other">Other (describe below)</option>
  </select></div>
  <div class="fg"><label>Issue Details</label><textarea class="fi" id="atIssue" rows="3" placeholder="Describe the issue…"></textarea></div>
  <div class="fr"><div class="fg"><label>Priority</label><select class="fi" id="atPriority"><option value="high">High — Device down</option><option value="medium" selected>Medium — Degraded</option><option value="low">Low — Enquiry/PM</option></select></div><div class="fg"><label>SLA</label><select class="fi" id="atSLA"><option>4 hours</option><option selected>8 hours</option><option>24 hours</option><option>48 hours</option></select></div></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('addTicket')">Cancel</button><button class="btn btn-p" onclick="saveTicket()">Create Ticket</button></div></div></div>

<!-- Reply -->
<div class="mo" id="mo-reply"><div class="mo-box"><div class="mo-h"><h2 id="replyTitle">Reply</h2><button class="mo-x" onclick="closeMo('reply')">×</button></div><div class="mo-b">
  <div class="fg"><label>To</label><input class="fi" id="replyTo" readonly></div>
  <div class="fg"><label>Subject</label><input class="fi" id="replySubj" readonly></div>
  <div class="fg"><label>Message</label><textarea class="fi" id="replyBody" rows="5"></textarea></div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('reply')">Cancel</button><button class="btn btn-p" onclick="sendReply()">Send Reply</button></div></div></div>

<!-- Email Info -->
<div class="mo" id="mo-emailInfo"><div class="mo-box"><div class="mo-h"><h2>Email Connection</h2><button class="mo-x" onclick="closeMo('emailInfo')">×</button></div><div class="mo-b" style="text-align:center;padding:20px">
  <div style="width:56px;height:56px;border-radius:50%;background:var(--sl);display:flex;align-items:center;justify-content:center;margin:0 auto 12px"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--su)" stroke-width="2"><path d="M9 11l3 3L22 4"/></svg></div>
  <h3 style="font-size:16px;font-weight:700;margin-bottom:4px">Email Connected</h3>
  <p style="font-size:13px;color:var(--t3);margin-bottom:16px">sales@jnacorporation.com</p>
  <div style="background:var(--s2);border-radius:var(--rs);padding:14px;text-align:left" id="emailStats"></div>
  <div style="margin-top:12px;padding:12px;background:var(--orl);border-radius:var(--rs);text-align:left;font-size:11.5px;color:var(--org)"><strong>⚠ Note:</strong> Real-time email sync requires a backend server. This CRM currently uses simulated email.</div>
</div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('emailInfo')">Close</button></div></div></div>

<!-- Agent -->
<div class="mo" id="mo-agentConfig"><div class="mo-box"><div class="mo-h"><h2 id="agentConfigTitle">Configure Agent</h2><button class="mo-x" onclick="closeMo('agentConfig')">×</button></div><div class="mo-b" id="agentConfigBody"></div><div class="mo-f"><button class="btn btn-o" onclick="closeMo('agentConfig')">Close</button><button class="btn btn-p" onclick="closeMo('agentConfig');showToast('Agent','Saved')">Save</button></div></div></div>
<div class="mo" id="mo-agentLogs"><div class="mo-box lg"><div class="mo-h"><h2 id="agentLogsTitle">Agent Logs</h2><button class="mo-x" onclick="closeMo('agentLogs')">×</button></div><div class="mo-b" id="agentLogsBody"></div></div></div>

<div class="toast" id="toast"><div class="toast-t"></div><div class="toast-m"></div></div>
<div class="confirm-overlay" id="confirmOverlay"><div class="confirm-box"><h3 id="cfTitle"></h3><p id="cfMsg"></p><div class="cf-btns"><button class="btn btn-o" id="cfCancel">Cancel</button><button class="btn btn-d" id="cfOk">Confirm</button></div></div></div>

<script>
// ══════════════════════════════════════════════════
// DATA
// ══════════════════════════════════════════════════
const users=[
  {email:'JNA',pass:'jnareh',name:'JNA Admin',init:'JA',role:'Administrator'},
];
let clinics=[];let clinicIdCounter=1;
let emails=[];let emailIdCounter=1;
let pipeline={Enquiry:[],Demo:[],Proposal:[],Negotiation:[],Purchased:[]};let pipeIdCounter=1;
let selectedDeal=null;let pipeViewMode='kanban';
let inv=[
  {id:1,n:'re:H Device',d:'Professional RF microneedling device',cost:465000,sell:500000,s:0,ro:5,cat:'device',ic:'pr',txns:[]},
  {id:2,n:'Balloon',d:'Balloon cartridge for re:H',cost:7700,sell:11000,s:0,ro:50,cat:'consumable',ic:'blu',txns:[]},
  {id:3,n:'Pink',d:'Pink cartridge for re:H',cost:6700,sell:9000,s:0,ro:50,cat:'consumable',ic:'pur',txns:[]},
  {id:4,n:'Toning',d:'Toning cartridge for re:H',cost:2350,sell:4500,s:0,ro:100,cat:'consumable',ic:'gld',txns:[]},
];
let svc=[];let svcIdCounter=1;
let targets=[];let targetIdCounter=1;
const aiAgents=[
  {n:'Email Intake Agent',d:'Monitors sales@jnacorporation.com. Auto-classifies, creates records.',st:'Active',c:'blu',m:'No activity yet'},
  {n:'Reorder Prediction',d:'Analyzes consumable usage. Proactive reminders.',st:'Active',c:'org',m:'No activity yet'},
  {n:'KPI Monitor',d:'Monthly spending vs target. Flags underperformers.',st:'Active',c:'pr',m:'No activity yet'},
  {n:'Warranty & PM',d:'Tracks warranty + maintenance schedules.',st:'Active',c:'pur',m:'No activity yet'},
  {n:'Lead Scoring',d:'Evaluates enquiry intent signals.',st:'Active',c:'gld',m:'No activity yet'},
  {n:'Follow-up Agent',d:'Sends automated 2-week post-demo follow-ups.',st:'Active',c:'g',m:'No activity yet'},
];
let acts=[];let notifications=[];
const CLR=['#13705E','#3563E9','#D97A1E','#6B4FCA','#B08C26','#CC3D4A','#0E8A9B','#3D4355'];
let currentEmailFilter='all',currentLfFilter='all',currentSvcFilter='all',currentInvFilter='all',currentPipeFilter='all',currentTargetFilter='all';

// ══════════════════════════════════════════════════
// UTILS
// ══════════════════════════════════════════════════
function showToast(t,m,type=''){const el=document.getElementById('toast');el.className='toast'+(type?' '+type:'');el.querySelector('.toast-t').textContent=t;el.querySelector('.toast-m').textContent=m;el.classList.add('show');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),3000)}
function openMo(id){document.getElementById('mo-'+id).classList.add('show')}
function closeMo(id){document.getElementById('mo-'+id).classList.remove('show')}
function confirmDlg(title,msg){return new Promise(res=>{const ov=document.getElementById('confirmOverlay');document.getElementById('cfTitle').textContent=title;document.getElementById('cfMsg').textContent=msg;ov.classList.add('show');document.getElementById('cfOk').onclick=()=>{ov.classList.remove('show');res(true)};document.getElementById('cfCancel').onclick=()=>{ov.classList.remove('show');res(false)}})}
function addAct(tx,type='info'){const icons={info:{bg:'var(--bll)',ic:'var(--blu)',p:'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'},success:{bg:'var(--sl)',ic:'var(--su)',p:'M9 11l3 3L22 4'},warning:{bg:'var(--orl)',ic:'var(--org)',p:'M12 9v2m0 4h.01M12 2l10 18H2L12 2z'}};const i=icons[type]||icons.info;const now=new Date();const tm=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');acts.unshift({tx,tm,bg:i.bg,ic:i.ic,p:i.p});if(acts.length>30)acts.pop();renderActs()}
function navTo(pg){document.querySelector(`.sb-i[data-pg="${pg}"]`).click()}
function fmtB(n){return n>=1e6?'฿'+(n/1e6).toFixed(2)+'M':n>=1e3?'฿'+(n/1e3).toFixed(0)+'K':'฿'+n.toLocaleString()}
function fmtDate(d){if(!d)return'—';return new Date(d).toLocaleDateString('en',{year:'numeric',month:'short',day:'numeric'})}
function todayStr(){return new Date().toISOString().split('T')[0]}
function getClinic(id){return clinics.find(c=>c.id===id)}
function daysBetween(d1,d2){return Math.round((new Date(d2)-new Date(d1))/(1e3*60*60*24))}

// ══════════════════════════════════════════════════
// LOGIN
// ══════════════════════════════════════════════════
function handleLogin(){const e=document.getElementById('loginEmail').value.trim();const p=document.getElementById('loginPass').value;const u=users.find(u=>u.email.toLowerCase()===e.toLowerCase()&&u.pass===p);if(u){document.getElementById('loginBtn').classList.add('loading');document.getElementById('loginBtn').textContent='Signing in…';setTimeout(()=>{document.getElementById('loginScreen').classList.add('hidden');document.getElementById('appShell').classList.add('show');document.getElementById('userName').textContent=u.name;document.getElementById('userRole').textContent=u.role;document.getElementById('userAv').textContent=u.init;showToast('Welcome','Signed in as '+u.name);initApp()},600)}else{document.getElementById('loginError').classList.add('show')}}
function handleLogout(){document.getElementById('appShell').classList.remove('show');document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('loginBtn').classList.remove('loading');document.getElementById('loginBtn').textContent='Sign In to CRM';document.getElementById('loginError').classList.remove('show')}
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')handleLogin()});
document.getElementById('loginEmail').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});

// NAV
const pgI={dash:['Dashboard','re:H distribution overview'],inbox:['Email Inbox','Auto-captured from sales@jnacorporation.com'],lifecycle:['Clinic Lifecycle','Lifecycle management + personnel + KPIs'],targets:['Target Clinics','Prospect pool and coverage goals'],orders:['Orders & Pipeline','Active pipeline + purchase history'],inventory:['Inventory','re:H devices and consumables'],service:['After-Sales','Service tickets & SLA tracking'],ai:['AI Agents','6 active agents'],settings:['Settings','Configuration']};
document.querySelectorAll('.sb-i[data-pg]').forEach(i=>{i.addEventListener('click',()=>{document.querySelectorAll('.sb-i').forEach(n=>n.classList.remove('act'));i.classList.add('act');const p=i.dataset.pg;document.querySelectorAll('.pg').forEach(pg=>pg.classList.remove('act'));document.getElementById('pg-'+p).classList.add('act');document.getElementById('pgT').textContent=pgI[p][0];document.getElementById('pgD').textContent=pgI[p][1]})});

// SEARCH
const gSearch=document.getElementById('gSearch'),searchDrop=document.getElementById('searchDrop');
gSearch.addEventListener('input',()=>{const q=gSearch.value.toLowerCase().trim();if(!q){searchDrop.classList.remove('show');return}let html='';
  clinics.filter(c=>(c.name+c.contact+c.region).toLowerCase().includes(q)).slice(0,5).forEach(c=>{html+=`<div class="sr-i" onclick="navTo('lifecycle');searchDrop.classList.remove('show');gSearch.value=''"><strong>${c.name}</strong> — ${c.stage}</div>`});
  targets.filter(t=>(t.name+t.contact).toLowerCase().includes(q)).slice(0,3).forEach(t=>{html+=`<div class="sr-i" onclick="navTo('targets');searchDrop.classList.remove('show');gSearch.value=''"><strong>${t.name}</strong> — target</div>`});
  if(!html)html='<div style="padding:16px;text-align:center;font-size:12px;color:var(--t3)">No results</div>';
  searchDrop.innerHTML=html;searchDrop.classList.add('show')});
gSearch.addEventListener('blur',()=>setTimeout(()=>searchDrop.classList.remove('show'),200));
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();gSearch.focus()}if(e.key==='Escape')document.querySelectorAll('.mo.show').forEach(m=>m.classList.remove('show'))});

// NOTIF
const notifBtn=document.getElementById('notifBtn'),notifDrop=document.getElementById('notifDrop');
notifBtn.addEventListener('click',e=>{e.stopPropagation();notifDrop.classList.toggle('show');renderNotifs()});
document.addEventListener('click',()=>notifDrop.classList.remove('show'));
notifDrop.addEventListener('click',e=>e.stopPropagation());
function renderNotifs(){const ur=notifications.filter(n=>!n.read).length;document.getElementById('notifDot').style.display=ur?'':'none';notifDrop.innerHTML=`<div class="nd-h"><h4>Notifications${ur?' ('+ur+')':''}</h4><span onclick="notifications.forEach(n=>n.read=true);renderNotifs()">Mark read</span></div>`+(notifications.length?notifications.slice(0,10).map(n=>`<div class="nd-i"><div style="width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:5px;background:${n.read?'var(--s3)':n.color||'var(--blu)'}"></div><div><div style="font-size:11.5px">${n.txt}</div><div style="font-size:10px;color:var(--t4)">${n.time}</div></div></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--t4);font-size:12px">None</div>')}

function makeFilters(id,filters,onChange){const el=document.getElementById(id);if(!el)return;el.innerHTML=filters.map((f,i)=>`<button class="btn btn-o${i===0?' act':''}" data-val="${f.val}">${f.label}</button>`).join('');el.querySelectorAll('.btn').forEach(btn=>btn.addEventListener('click',()=>{el.querySelectorAll('.btn').forEach(b=>b.classList.remove('act'));btn.classList.add('act');onChange(btn.dataset.val)}))}

function initApp(){initFilters();initSettings();addOrderLine();renderAll();populateDropdowns();
  // Auto-calculate package total in Add Record modal
  ['arPkgDev','arPkgBalloon','arPkgPink','arPkgToning'].forEach(id=>{const el=document.getElementById(id);if(el){el.addEventListener('input',calcPkgTotal);el.addEventListener('change',calcPkgTotal)}});}
function calcPkgTotal(){const items=[{q:'arPkgDev',p:'arPriceDev'},{q:'arPkgBalloon',p:'arPriceBalloon'},{q:'arPkgPink',p:'arPricePink'},{q:'arPkgToning',p:'arPriceToning'}];let total=0;const subs=document.querySelectorAll('.ar-sub');items.forEach((it,i)=>{const qty=parseInt(document.getElementById(it.q).value)||0;const price=parseInt(document.getElementById(it.p).value)||0;const sub=qty*price;total+=sub;if(subs[i])subs[i].textContent='฿'+sub.toLocaleString()});document.getElementById('arPkgTotal').innerHTML='Package Total: <strong>฿'+total.toLocaleString()+'</strong>'}
function renderAll(){renderStats();renderGauge();renderAIInsights();renderChart();renderActs();renderInvStatus();renderPipeSummary();renderEmails();renderLF();renderTargets();renderPipe();renderPurchaseHistory();renderInv();renderInvHistory();renderSvc();renderAI();renderNotifs();updateBadges();renderEmailStats()}
function initFilters(){
  makeFilters('emailFilters',[{val:'all',label:'All'},{val:'enquiry',label:'Enquiries'},{val:'reorder',label:'Reorders'},{val:'service',label:'Service'}],v=>{currentEmailFilter=v;renderEmails()});
  makeFilters('lfFilters',[{val:'all',label:'All'},{val:'enquiry',label:'Enquiry'},{val:'waiting',label:'Waiting'},{val:'installing',label:'Installing'},{val:'active',label:'Active'},{val:'churned',label:'Churned'}],v=>{currentLfFilter=v;renderLF()});
  makeFilters('targetFilters',[{val:'all',label:'All'},{val:'not_approached',label:'Not Approached'},{val:'contacted',label:'Contacted'},{val:'waiting',label:'Waiting'},{val:'converted',label:'Converted'}],v=>{currentTargetFilter=v;renderTargets()});
  makeFilters('svcFilters',[{val:'all',label:'All'},{val:'Open',label:'Open'},{val:'Pending',label:'Pending'},{val:'Resolved',label:'Resolved'}],v=>{currentSvcFilter=v;renderSvc()});
  makeFilters('invFilters',[{val:'all',label:'All'},{val:'device',label:'Devices'},{val:'consumable',label:'Consumables'}],v=>{currentInvFilter=v;renderInv()});
  makeFilters('pipeFilters',[{val:'all',label:'All'},{val:'Enquiry',label:'Enquiry'},{val:'Demo',label:'Demo'},{val:'Proposal',label:'Proposal'},{val:'Negotiation',label:'Negotiation'},{val:'Purchased',label:'Purchased'}],v=>{currentPipeFilter=v;renderPipe()});
}
function updateBadges(){
  document.getElementById('inboxBadge').textContent=emails.filter(e=>!e.read&&!e.archived).length;
  document.getElementById('svcBadge').textContent=svc.filter(t=>t.st!=='Resolved').length;
  document.getElementById('targetBadge').textContent=targets.filter(t=>t.status!=='converted').length;
}
function populateDropdowns(){
  const co='<option value="">Select Clinic…</option>'+clinics.map(c=>`<option value="${c.id}">${c.name}${c.branch&&c.branch!=='—'?' — '+c.branch:''}</option>`).join('');
  ['aoClinic','ioClinic','atClinic'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=co});
  document.getElementById('ebClinic').innerHTML=co;
  const po=inv.map(p=>`<option value="${p.id}">${p.n} — Cost ฿${p.cost.toLocaleString()} / Sell ฿${p.sell.toLocaleString()}</option>`).join('');
  ['iiProduct','ioProduct'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=po});
}

// ══════════════════════════════════════════════════
// DASHBOARD
// ══════════════════════════════════════════════════
function renderStats(){
  const enq=clinics.filter(c=>c.stage==='enquiry').length,active=clinics.filter(c=>c.stage==='active').length;
  const rev=clinics.reduce((a,c)=>a+c.spend,0),devs=clinics.reduce((a,c)=>a+c.dev,0);
  const stats=[
    {v:clinics.length,l:'Total Clinics',ch:'All stages',bg:'var(--bll)',ic:'var(--blu)',p:'M3 21h18M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16'},
    {v:enq,l:'Enquiries',ch:'Pipeline',bg:'var(--orl)',ic:'var(--org)',p:'M4 4h16c1.1 0 2 .9 2 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6c0-1.1.9-2 2-2z'},
    {v:active,l:'Active Branches',ch:'Installed',bg:'var(--pl)',ic:'var(--pr)',p:'M9 11l3 3L22 4'},
    {v:fmtB(rev),l:'Total Revenue',ch:'Lifetime',bg:'var(--gll)',ic:'var(--gld)',p:'M12 1v22M17 5H9.5a3.5 3.5 0 100 7h5a3.5 3.5 0 010 7H6'},
    {v:devs,l:'Devices Deployed',ch:'In field',bg:'var(--pul)',ic:'var(--pur)',p:'M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z'},
  ];
  document.getElementById('dashStats').innerHTML=stats.map(s=>`<div class="st"><div class="st-top"><div class="st-ic" style="background:${s.bg}"><svg viewBox="0 0 24 24" fill="none" stroke="${s.ic}" stroke-width="2"><path d="${s.p}"/></svg></div><div class="st-ch up">${s.ch}</div></div><div class="st-v">${s.v}</div><div class="st-l">${s.l}</div></div>`).join('');
}
function renderGauge(){
  const total=(targets.length+clinics.length)||1;const installed=clinics.filter(c=>c.stage==='active').length+targets.filter(t=>t.status==='converted').length;
  const pct=Math.round((installed/total)*100);const deg=Math.min(180,(pct/100)*180);
  document.getElementById('gaugeArea').innerHTML=`<div class="gauge-wrap"><div class="gauge-bg"><div class="gauge-fill" style="transform:rotate(${deg-180}deg)"></div></div><div class="gauge-cover"><div class="gauge-val">${pct}%</div></div></div><div class="gauge-label">${installed} installed / ${total} total</div><div style="font-size:10px;color:var(--t4);margin-top:4px">${targets.filter(t=>t.status!=='converted').length} prospects remaining</div>`;
}
function renderChart(){document.getElementById('mainChart').innerHTML=clinics.filter(c=>c.stage==='active').length?clinics.filter(c=>c.stage==='active').slice(0,6).map((c,i,a)=>{const mx=Math.max(...a.map(x=>x.dev),1);return`<div class="cg"><div class="cbs"><div class="cb a" style="height:${(c.dev/mx)*100}%" data-val="${c.dev} dev"></div><div class="cb b" style="height:${(c.avg/Math.max(...a.map(x=>x.avg),1))*100}%" data-val="฿${Math.round(c.avg/1e3)}K"></div></div><span class="cl">${c.name.split(' ')[0]}</span></div>`}).join('')+'<div class="ch-lg"><span><span class="dt" style="background:var(--pr)"></span>Devices</span><span><span class="dt" style="background:var(--blu);opacity:.45"></span>Avg ฿K</span></div>':'<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--t4);font-size:12px">No active clinics yet</div>'}
function renderAIInsights(){const lS=inv.filter(p=>p.s<=p.ro&&p.s>0).length,zS=inv.filter(p=>p.s===0).length;const pV=Object.values(pipeline).flat().reduce((a,d)=>a+(d.total||0),0);const dueFU=targets.filter(t=>t.demoDate&&t.status!=='converted'&&daysBetween(t.demoDate,todayStr())>=14).length;
  // Reorder overdue clinics
  const reorderOverdue=clinics.filter(c=>{if(!c.reorderCycle||c.reorderCycle<=0)return false;const lastP=c.purchases.length?c.purchases[c.purchases.length-1]:null;const ref=lastP?lastP.date:c.firstPurchase;if(!ref)return false;return daysBetween(ref,todayStr())>=c.reorderCycle}).length;
  document.getElementById('aiInsights').innerHTML=`<div class="ai-cd"><div class="ai-ic" style="background:var(--bll)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--blu)" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6c0-1.1.9-2 2-2z"/></svg></div><div><div style="font-weight:600;font-size:12px">${emails.filter(e=>!e.read&&!e.archived).length} Unread Emails</div><div style="font-size:11px;color:var(--t3)">sales@ inbox</div></div></div>${reorderOverdue>0?`<div class="ai-cd"><div class="ai-ic" style="background:var(--dl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--dg)" stroke-width="2"><path d="M12 9v2m0 4h.01M12 2l10 18H2L12 2z"/></svg></div><div><div style="font-weight:600;font-size:12px;color:var(--dg)">${reorderOverdue} Reorder Overdue</div><div style="font-size:11px;color:var(--t3)">Clinics past reorder cycle</div></div></div>`:''}<div class="ai-cd"><div class="ai-ic" style="background:var(--orl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--org)" stroke-width="2"><path d="M21 16V8l-7-4-7 4v8l7 4 7-4z"/></svg></div><div><div style="font-weight:600;font-size:12px">${zS>0?zS+' Out of Stock':lS>0?lS+' Low Stock':'Inventory OK'}</div></div></div>${dueFU>0?`<div class="ai-cd"><div class="ai-ic" style="background:var(--pul)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--pur)" stroke-width="2"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg></div><div><div style="font-weight:600;font-size:12px;color:var(--pur)">${dueFU} Follow-ups Due</div><div style="font-size:11px;color:var(--t3)">2+ weeks since demo</div></div></div>`:''}<div class="ai-cd"><div class="ai-ic" style="background:var(--sl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--su)" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><div><div style="font-weight:600;font-size:12px">Pipeline: ${fmtB(pV)}</div></div></div>`}
function renderActs(){document.getElementById('actFeed').innerHTML=acts.length?acts.slice(0,8).map(a=>`<div class="ai-i"><div class="ai-iic" style="background:${a.bg}"><svg viewBox="0 0 24 24" fill="none" stroke="${a.ic}" stroke-width="2"><path d="${a.p}"/></svg></div><div><div style="font-size:11.5px">${a.tx}</div><div style="font-size:10px;color:var(--t4)">${a.tm}</div></div></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--t4);font-size:12px">No activity yet</div>'}
function renderInvStatus(){document.getElementById('invStatus').innerHTML=inv.map(p=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bl);font-size:12px"><span>${p.n}</span><span style="font-weight:700;${p.s<=p.ro?'color:var(--dg)':''}">${p.s}</span></div>`).join('')}
function renderPipeSummary(){document.getElementById('pipeSummary').innerHTML=Object.keys(pipeline).map(s=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bl);font-size:12px"><span>${s}</span><span><strong>${pipeline[s].length}</strong> · ${fmtB(pipeline[s].reduce((a,d)=>a+(d.total||0),0))}</span></div>`).join('')}
function exportDashCSV(){let csv='Clinic,Region,Stage,Tier,Devices,Spend,AvgMonthly,KPI\n';clinics.forEach(c=>{csv+=`"${c.name}",${c.region},${c.stage},${c.tier},${c.dev},${c.spend},${c.avg},${c.kpi}\n`});const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='reh-export.csv';a.click();showToast('Export','CSV downloaded')}

// ══════════════════════════════════════════════════
// EMAIL
// ══════════════════════════════════════════════════
function renderEmails(){const tc={enquiry:'b',reorder:'g',service:'r'},tl={enquiry:'Enquiry',reorder:'Reorder',service:'Service'};let f=emails.filter(e=>!e.archived);if(currentEmailFilter!=='all')f=f.filter(e=>e.type===currentEmailFilter);
  if(!f.length){document.getElementById('emailList').innerHTML='<div style="padding:40px;text-align:center;color:var(--t4);font-size:12px">No emails — click Sync Now</div>';return}
  document.getElementById('emailList').innerHTML=f.map(e=>`<div class="em-i"><div style="width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;background:${e.read?'var(--s3)':'var(--blu)'}"></div><div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:6px;margin-bottom:2px"><span style="font-weight:${e.read?500:700};font-size:12.5px">${e.from}</span><span class="tg ${tc[e.type]}" style="font-size:9px">${tl[e.type]}</span></div><div style="font-size:12px;font-weight:${e.read?400:600}">${e.subj}</div><div style="font-size:11px;color:var(--t3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.prev}</div><div style="display:flex;gap:4px;margin-top:4px"><button class="btn btn-sm btn-p" onclick="event.stopPropagation();createRecordFromEmail(${e.id})">→ Create Record</button><button class="btn btn-sm btn-o" onclick="event.stopPropagation();openReply(${e.id})">Reply</button><button class="btn btn-sm btn-o" onclick="event.stopPropagation();archiveEmail(${e.id})">Archive</button></div></div><div style="font-size:10px;color:var(--t4);white-space:nowrap">${e.time}</div></div>`).join('')}
function createRecordFromEmail(id){const e=emails.find(x=>x.id===id);if(!e)return;e.read=true;if(clinics.find(c=>c.name.toLowerCase()===e.from.toLowerCase())){showToast('Exists','Already exists','warning');renderEmails();return}clinics.push({id:clinicIdCounter++,name:e.from,branch:'—',contact:e.from,email:e.email||'',phone:'',region:'Bangkok',stage:'enquiry',source:'Email',tier:'Standard',inst:null,dev:0,spend:0,avg:0,kpi:130000,last:'—',personnel:[],purchases:[],firstPurchase:null,initPkg:[],initPkgTotal:0,contractType:'',warrantyStart:null,reorderCycle:90,notes:'Created from email',activities:[{type:'email',subject:'Enquiry from email',body:'Record auto-created from incoming email',date:todayStr(),by:'AI Agent',ts:Date.now()}]});addAct(`<strong>Email → Record</strong> ${e.from}`,'success');showToast('Created',e.from);renderAll();populateDropdowns()}
function openReply(id){const e=emails.find(x=>x.id===id);if(!e)return;e.read=true;renderEmails();document.getElementById('replyTo').value=e.email;document.getElementById('replySubj').value='Re: '+e.subj;document.getElementById('replyBody').value='';document.getElementById('replyTitle').textContent='Reply to '+e.from;openMo('reply')}
function sendReply(){closeMo('reply');showToast('Sent','Reply sent');addAct(`<strong>Email</strong> reply sent`,'success')}
function archiveEmail(id){const e=emails.find(x=>x.id===id);if(!e)return;e.archived=true;addAct(`<strong>Email archived</strong>`,'info');showToast('Archived','Done');renderEmails();updateBadges()}
function simulateNewEmail(){const names=['Dr. Yada Suksri','Dr. Kanya Pimchai','Khun Praew Manorom','Dr. Wichai Suthep','Dr. Nattaya Boon'];const subjs=['re:H enquiry — new clinic','Cartridge reorder request','Demo request for re:H','Service issue with device','Interested in re:H pricing'];const types=['enquiry','reorder','enquiry','service','enquiry'];const ri=Math.floor(Math.random()*names.length);emails.unshift({id:emailIdCounter++,from:names[ri],email:names[ri].toLowerCase().replace(/[^a-z]/g,'')+'@clinic.co.th',subj:subjs[ri],prev:'I am writing to enquire about your re:H product line…',time:'Just now',type:types[ri],read:false,archived:false});notifications.unshift({txt:`New email from ${names[ri]}`,time:'Just now',color:'var(--blu)',read:false});addAct(`<strong>AI Agent</strong> captured ${types[ri]} from ${names[ri]}`,'info');showToast('New Email',names[ri]);renderAll()}
function renderEmailStats(){document.getElementById('emailStats').innerHTML=`<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px"><span style="color:var(--t3)">Total processed</span><span style="font-weight:600">${emails.length}</span></div><div style="display:flex;justify-content:space-between;font-size:12px"><span style="color:var(--t3)">Unread</span><span style="font-weight:600">${emails.filter(e=>!e.read&&!e.archived).length}</span></div>`}

// ══════════════════════════════════════════════════
// CLINIC LIFECYCLE (merged with Portfolio) - uses clinic.id not array index
// ══════════════════════════════════════════════════
function renderLF(){
  const counts={enquiry:0,waiting:0,installing:0,active:0,churned:0};clinics.forEach(c=>counts[c.stage]=(counts[c.stage]||0)+1);
  document.getElementById('lfBar').innerHTML=['all','enquiry','waiting','installing','active','churned'].map(s=>`<div class="lf-s${currentLfFilter===s?' act':''}" onclick="currentLfFilter='${s}';renderLF()"><div class="num">${s==='all'?clinics.length:counts[s]||0}</div><div class="nm">${s==='all'?'All':s}</div><div class="bar"></div></div>`).join('');
  const sc={enquiry:'b',waiting:'o',installing:'p',active:'g',churned:'n'};
  let filtered=currentLfFilter==='all'?clinics:clinics.filter(c=>c.stage===currentLfFilter);
  document.getElementById('lfTable').innerHTML=filtered.length?filtered.map(c=>{
    const tp=c.purchases.reduce((a,p)=>a+p.total,0)+(c.initPkgTotal||0);
    const lastP=c.purchases.length?c.purchases[c.purchases.length-1]:null;
    const daysSinceLast=lastP?daysBetween(lastP.date,todayStr()):c.firstPurchase?daysBetween(c.firstPurchase,todayStr()):null;
    const reorderDue=daysSinceLast!==null&&c.reorderCycle>0&&daysSinceLast>=c.reorderCycle;
    const reorderSoon=daysSinceLast!==null&&c.reorderCycle>0&&daysSinceLast>=c.reorderCycle-14&&!reorderDue;
    const hs=calcHealthScore(c);
    const hsColor=hs>=80?'var(--su)':hs>=50?'var(--org)':'var(--dg)';
    const hsLabel=hs>=80?'Good':hs>=50?'Fair':'At Risk';
    const pb=getProductBreakdown(c);
    const consumTotal=pb.balloon+pb.pink+pb.toning;
    return `<tr onclick="showClinicDetail(${c.id})">
    <td><div class="ec"><div class="ec-av" style="background:${CLR[c.id%8]}">${c.name.split(' ').map(w=>w[0]).slice(0,2).join('')}</div><div><div class="ec-n">${c.name}</div><div class="ec-s">${c.branch||'—'} · ${c.tier}${c.contractType?' · '+c.contractType:''}</div></div></div></td>
    <td style="font-size:12px">${c.contact}<br><span style="color:var(--t4);font-size:10px">${c.phone||c.email||''}</span></td>
    <td style="font-size:12px">${c.region}</td>
    <td><span class="tg ${sc[c.stage]}">${c.stage}</span></td>
    <td><div style="text-align:center"><div style="font-size:16px;font-weight:800;color:${hsColor}">${hs}</div><div style="font-size:9px;color:${hsColor};font-weight:600">${hsLabel}</div></div></td>
    <td style="font-size:11px">${c.firstPurchase?fmtDate(c.firstPurchase):'<span style="color:var(--t4)">—</span>'}</td>
    <td style="font-size:11px">${lastP?fmtDate(lastP.date)+(daysSinceLast!==null?'<br><span style="color:var(--t4);font-size:9px">'+daysSinceLast+'d ago</span>':''):'<span style="color:var(--t4)">—</span>'}</td>
    <td>${reorderDue?'<span class="tg r" style="font-size:9px">⚠ Overdue</span>':reorderSoon?'<span class="tg o" style="font-size:9px">Soon</span>':c.reorderCycle&&c.firstPurchase?'<span class="tg g" style="font-size:9px">OK</span>':'<span style="color:var(--t4);font-size:10px">—</span>'}</td>
    <td style="text-align:center"><span style="font-weight:700">${c.dev||0}</span>${consumTotal>0?'<br><span style="font-size:9px;color:var(--t4)">'+consumTotal+' carts</span>':''}</td>
    <td style="font-weight:700">${fmtB(tp||c.spend)}</td>
    <td><div style="display:flex;gap:4px;flex-wrap:wrap" onclick="event.stopPropagation()">${c.stage!=='active'&&c.stage!=='churned'?`<button class="btn btn-sm btn-p" onclick="advanceStage(${c.id})">Advance →</button>`:`<span class="tg ${c.stage==='active'?'g':'n'}" style="font-size:10px">${c.stage==='active'?'✓ Active':'Churned'}</span>`}<button class="btn btn-sm btn-blu" onclick="openRecordPurchase(${c.id})">+Purchase</button><button class="btn btn-sm btn-d" onclick="removeRecord(${c.id})">×</button></div></td></tr>`}).join(''):'<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--t4)">No clinics — click "Add Clinic"</td></tr>';
}
function advanceStage(cid){const c=getClinic(cid);if(!c)return;const order=['enquiry','waiting','installing','active'];const idx=order.indexOf(c.stage);if(c.stage==='churned'){showToast('Info','Churned cannot advance','warning');return}if(idx>=0&&idx<order.length-1){c.stage=order[idx+1];if(order[idx+1]==='active'&&!c.inst)c.inst=todayStr();if(!c.activities)c.activities=[];c.activities.unshift({type:'stage',subject:'Stage → '+order[idx+1],body:'Lifecycle stage advanced',date:todayStr(),by:'JNA Admin',ts:Date.now()});addAct(`<strong>${c.name}</strong> → ${order[idx+1]}`,'success');showToast('Advanced',c.name+' → '+order[idx+1]);renderAll()}else{showToast('Info','Already at final stage','warning')}}
async function removeRecord(cid){const c=getClinic(cid);if(!c)return;const ok=await confirmDlg('Remove?','Remove "'+c.name+'"?');if(!ok)return;clinics=clinics.filter(x=>x.id!==cid);addAct(`<strong>${c.name}</strong> removed`,'warning');showToast('Removed',c.name);renderAll();populateDropdowns()}
function saveRecord(){const name=document.getElementById('arName').value.trim(),contact=document.getElementById('arContact').value.trim();if(!name||!contact){showToast('Error','Name and contact required','error');return}
  // Read per-clinic agreed prices from form
  const pDev=parseInt(document.getElementById('arPriceDev').value)||500000;
  const pBal=parseInt(document.getElementById('arPriceBalloon').value)||11000;
  const pPnk=parseInt(document.getElementById('arPricePink').value)||9000;
  const pTon=parseInt(document.getElementById('arPriceToning').value)||4500;
  const agreedPrices={'re:H Device':pDev,'Balloon':pBal,'Pink':pPnk,'Toning':pTon};
  // Build initial package using clinic's agreed prices
  const pkgDev=parseInt(document.getElementById('arPkgDev').value)||0;
  const pkgBalloon=parseInt(document.getElementById('arPkgBalloon').value)||0;
  const pkgPink=parseInt(document.getElementById('arPkgPink').value)||0;
  const pkgToning=parseInt(document.getElementById('arPkgToning').value)||0;
  const initPkg=[];let initPkgTotal=0;
  if(pkgDev>0){initPkg.push({product:'re:H Device',qty:pkgDev,price:pDev});initPkgTotal+=pkgDev*pDev}
  if(pkgBalloon>0){initPkg.push({product:'Balloon',qty:pkgBalloon,price:pBal});initPkgTotal+=pkgBalloon*pBal}
  if(pkgPink>0){initPkg.push({product:'Pink',qty:pkgPink,price:pPnk});initPkgTotal+=pkgPink*pPnk}
  if(pkgToning>0){initPkg.push({product:'Toning',qty:pkgToning,price:pTon});initPkgTotal+=pkgToning*pTon}
  const firstPurchase=document.getElementById('arFirstPurchase').value||null;
  const contractType=document.getElementById('arContract').value||'';
  const warrantyStart=document.getElementById('arWarranty').value||firstPurchase;
  const reorderCycle=parseInt(document.getElementById('arReorderCycle').value)||90;
  const notes=document.getElementById('arNotes').value||'';
  const purchases=[];
  if(initPkg.length>0&&firstPurchase){purchases.push({date:firstPurchase,items:initPkg.map(p=>p.product+(p.qty>1?' ×'+p.qty:'')).join(', '),total:initPkgTotal,payment:contractType||'—',notes:'Initial package',products:initPkg.map(p=>({name:p.product,qty:p.qty,price:p.price}))})}
  clinics.push({id:clinicIdCounter++,name,branch:document.getElementById('arBranch').value||'—',contact,email:document.getElementById('arEmail').value||'',phone:document.getElementById('arPhone').value||'',region:document.getElementById('arRegion').value,stage:document.getElementById('arStage').value,source:document.getElementById('arSource').value,tier:'Standard',inst:firstPurchase,dev:pkgDev,spend:initPkgTotal,avg:0,kpi:130000,last:firstPurchase||'—',personnel:[],purchases,firstPurchase,initPkg,initPkgTotal,contractType,warrantyStart,reorderCycle,notes,agreedPrices,activities:[]});
  closeMo('addRecord');['arName','arContact','arBranch','arEmail','arPhone','arNotes'].forEach(id=>document.getElementById(id).value='');['arPkgDev','arPkgBalloon','arPkgPink','arPkgToning'].forEach(id=>document.getElementById(id).value='0');document.getElementById('arPriceDev').value=500000;document.getElementById('arPriceBalloon').value=11000;document.getElementById('arPricePink').value=9000;document.getElementById('arPriceToning').value=4500;
  addAct(`<strong>${name}</strong> added`+(initPkgTotal?' — initial ฿'+initPkgTotal.toLocaleString():''),'success');showToast('Created',name);renderAll();populateDropdowns()}

// ═══════════════════════════════════════════════════
// ANALYTICS: Health Score, Product Breakdown, Consumption
// ═══════════════════════════════════════════════════
function calcHealthScore(c){
  // RFM-based: Recency (40%), Frequency (30%), Monetary (30%)
  let R=0,F=0,M=0;
  // Recency: days since last order (lower = better)
  const lastP=c.purchases.length?c.purchases[c.purchases.length-1]:null;
  const daysSince=lastP?daysBetween(lastP.date,todayStr()):c.firstPurchase?daysBetween(c.firstPurchase,todayStr()):999;
  const cycle=c.reorderCycle||90;
  if(daysSince<=cycle*0.5)R=100;else if(daysSince<=cycle)R=80;else if(daysSince<=cycle*1.5)R=50;else if(daysSince<=cycle*2)R=25;else R=5;
  if(!c.firstPurchase)R=0;
  // Frequency: orders per 6 months
  const months=c.firstPurchase?Math.max(1,daysBetween(c.firstPurchase,todayStr())/30):1;
  const ordersPerMo=c.purchases.length/months;
  if(ordersPerMo>=1)F=100;else if(ordersPerMo>=0.5)F=80;else if(ordersPerMo>=0.25)F=50;else if(c.purchases.length>=1)F=30;else F=0;
  // Monetary: total spend
  const tp=c.purchases.reduce((a,p)=>a+p.total,0)+(c.initPkgTotal||0);
  if(tp>=2000000)M=100;else if(tp>=1000000)M=80;else if(tp>=500000)M=60;else if(tp>=100000)M=40;else if(tp>0)M=20;else M=0;
  return Math.round(R*0.4+F*0.3+M*0.3);
}
function getProductBreakdown(c){
  // Aggregate all products across all purchases
  const pb={device:0,balloon:0,pink:0,toning:0,deviceAmt:0,balloonAmt:0,pinkAmt:0,toningAmt:0};
  // From initial package
  if(c.initPkg){c.initPkg.forEach(p=>{
    if(p.product==='re:H Device'){pb.device+=p.qty;pb.deviceAmt+=p.qty*p.price}
    else if(p.product==='Balloon'){pb.balloon+=p.qty;pb.balloonAmt+=p.qty*p.price}
    else if(p.product==='Pink'){pb.pink+=p.qty;pb.pinkAmt+=p.qty*p.price}
    else if(p.product==='Toning'){pb.toning+=p.qty;pb.toningAmt+=p.qty*p.price}
  })}
  // From purchase records with products array
  c.purchases.forEach(p=>{if(p.products){p.products.forEach(pr=>{
    if(pr.name==='re:H Device'){pb.device+=pr.qty;pb.deviceAmt+=pr.qty*pr.price}
    else if(pr.name==='Balloon'){pb.balloon+=pr.qty;pb.balloonAmt+=pr.qty*pr.price}
    else if(pr.name==='Pink'){pb.pink+=pr.qty;pb.pinkAmt+=pr.qty*pr.price}
    else if(pr.name==='Toning'){pb.toning+=pr.qty;pb.toningAmt+=pr.qty*pr.price}
  })}});
  return pb;
}
function getConsumptionRate(c){
  // Cartridges per month since first purchase
  if(!c.firstPurchase)return{balloon:0,pink:0,toning:0,total:0};
  const months=Math.max(1,daysBetween(c.firstPurchase,todayStr())/30);
  const pb=getProductBreakdown(c);
  return{balloon:+(pb.balloon/months).toFixed(1),pink:+(pb.pink/months).toFixed(1),toning:+(pb.toning/months).toFixed(1),total:+((pb.balloon+pb.pink+pb.toning)/months).toFixed(1)};
}
function getPurchaseTimeline(c){
  // Get chronological purchase dates with gaps
  const dates=[];
  if(c.firstPurchase&&c.initPkg&&c.initPkg.length)dates.push({date:c.firstPurchase,label:'Initial',total:c.initPkgTotal||0});
  c.purchases.forEach(p=>{if(p.notes!=='Initial package')dates.push({date:p.date,label:'Reorder',total:p.total})});
  dates.sort((a,b)=>new Date(a.date)-new Date(b.date));
  // Calculate gaps
  for(let i=1;i<dates.length;i++){dates[i].gap=daysBetween(dates[i-1].date,dates[i].date)}
  return dates;
}
function predictNextOrders(c){
  // Per-product prediction based on consumption rate
  const cr=getConsumptionRate(c);const cycle=c.reorderCycle||90;
  const lastP=c.purchases.length?c.purchases[c.purchases.length-1]:null;
  const lastDate=lastP?lastP.date:c.firstPurchase;
  if(!lastDate)return null;
  const nextDate=new Date(new Date(lastDate).getTime()+cycle*86400000).toISOString().split('T')[0];
  const isOverdue=daysBetween(lastDate,todayStr())>=cycle;
  return{nextDate,isOverdue,daysUntil:daysBetween(todayStr(),nextDate),estBalloon:Math.max(1,Math.round(cr.balloon*cycle/30)),estPink:Math.max(1,Math.round(cr.pink*cycle/30)),estToning:Math.max(1,Math.round(cr.toning*cycle/30)),estTotal:Math.round((cr.balloon*getClinicPrice(c,'Balloon')+cr.pink*getClinicPrice(c,'Pink')+cr.toning*getClinicPrice(c,'Toning'))*(cycle/30))};
}

// ═══════════════════════════════════════════════════
// PRICE HELPER: per-clinic agreed prices with fallback
// ═══════════════════════════════════════════════════
const DEFAULT_PRICES={'re:H Device':500000,'Balloon':11000,'Pink':9000,'Toning':4500};
function getClinicPrice(c,product){return(c&&c.agreedPrices&&c.agreedPrices[product])||DEFAULT_PRICES[product]||0}
function getClinicPrices(c){return{dev:getClinicPrice(c,'re:H Device'),bal:getClinicPrice(c,'Balloon'),pnk:getClinicPrice(c,'Pink'),ton:getClinicPrice(c,'Toning')}}

// ═══════════════════════════════════════════════════
// RECORD PURCHASE (uses clinic's agreed prices)
// ═══════════════════════════════════════════════════
function openRecordPurchase(cid){const c=getClinic(cid);if(!c)return;
  document.getElementById('rpClinicId').value=cid;
  document.getElementById('rpTitle').textContent='Record Purchase — '+c.name;
  const pr=getClinicPrices(c);
  const items=[{key:'rpDev',label:'re:H Device',color:'var(--pr)',price:pr.dev},{key:'rpBalloon',label:'Balloon',color:'var(--blu)',price:pr.bal},{key:'rpPink',label:'Pink',color:'var(--pur)',price:pr.pnk},{key:'rpToning',label:'Toning',color:'var(--gld)',price:pr.ton}];
  document.getElementById('rpProductGrid').innerHTML=`
    <div style="padding:8px 12px;background:var(--bll);border-radius:var(--rs);margin-bottom:10px;font-size:11px;color:var(--blu)">💰 Using <strong>${c.name}</strong>'s agreed prices</div>
    <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:6px;margin-bottom:4px;font-size:9px;color:var(--t4);text-transform:uppercase;padding:0 4px"><span>Product</span><span>Qty</span><span>Unit Price</span><span>Subtotal</span></div>
    ${items.map(it=>`<div class="rp-row" data-price="${it.price}" style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:6px;margin-bottom:6px;align-items:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-size:12px;font-weight:600;color:${it.color}">${it.label}</span><input class="fi rp-qty" type="number" id="${it.key}" value="0" min="0" style="text-align:center" oninput="calcRpTotal()"><span style="font-size:11px;color:var(--t3)">฿${it.price.toLocaleString()}</span><span class="rp-sub" style="font-size:11px;font-weight:600;color:var(--pr)">฿0</span></div>`).join('')}`;
  document.getElementById('rpDate').value=todayStr();document.getElementById('rpNotes').value='';calcRpTotal();openMo('recordPurchase')}
function calcRpTotal(){let total=0;document.querySelectorAll('.rp-row').forEach(row=>{const price=parseInt(row.dataset.price)||0;const qty=parseInt(row.querySelector('.rp-qty').value)||0;const sub=price*qty;row.querySelector('.rp-sub').textContent='฿'+sub.toLocaleString();total+=sub});document.getElementById('rpTotal').textContent='฿'+total.toLocaleString()}
function saveRepurchase(){
  const cid=parseInt(document.getElementById('rpClinicId').value);const c=getClinic(cid);if(!c)return;
  const pr=getClinicPrices(c);
  const d=parseInt(document.getElementById('rpDev').value)||0,b=parseInt(document.getElementById('rpBalloon').value)||0,pk=parseInt(document.getElementById('rpPink').value)||0,t=parseInt(document.getElementById('rpToning').value)||0;
  if(d+b+pk+t===0){showToast('Error','Select at least 1 product','error');return}
  const products=[];let total=0;const itemParts=[];
  if(d>0){products.push({name:'re:H Device',qty:d,price:pr.dev});total+=d*pr.dev;itemParts.push('re:H Device'+(d>1?' ×'+d:''))}
  if(b>0){products.push({name:'Balloon',qty:b,price:pr.bal});total+=b*pr.bal;itemParts.push('Balloon'+(b>1?' ×'+b:''))}
  if(pk>0){products.push({name:'Pink',qty:pk,price:pr.pnk});total+=pk*pr.pnk;itemParts.push('Pink'+(pk>1?' ×'+pk:''))}
  if(t>0){products.push({name:'Toning',qty:t,price:pr.ton});total+=t*pr.ton;itemParts.push('Toning'+(t>1?' ×'+t:''))}
  const date=document.getElementById('rpDate').value||todayStr();const payment=document.getElementById('rpPayment').value;const notes=document.getElementById('rpNotes').value;
  c.purchases.push({date,items:itemParts.join(', '),total,payment,notes,products});
  c.spend+=total;c.last=date;c.dev+=d;
  if(c.firstPurchase){const months=Math.max(1,daysBetween(c.firstPurchase,todayStr())/30);const totalSpend=c.purchases.reduce((a,p)=>a+p.total,0)+(c.initPkgTotal||0);c.avg=Math.round(totalSpend/months)}
  if(!c.activities)c.activities=[];c.activities.unshift({type:'purchase',subject:'Purchase: '+itemParts.join(', '),body:fmtB(total)+' via '+payment,date,by:'JNA Admin',ts:Date.now()});closeMo('recordPurchase');addAct(`<strong>Purchase</strong> ${itemParts.join(', ')} → ${c.name} (${fmtB(total)})`,'success');
  showToast('Recorded',c.name+' — '+fmtB(total));renderAll();populateDropdowns()}
function showClinicDetail(cid){const c=getClinic(cid);if(!c)return;
  const tp=c.purchases.reduce((a,p)=>a+p.total,0)+(c.initPkgTotal||0);const kp=c.kpi?Math.round((c.avg/c.kpi)*100):0;
  const purchCount=c.purchases.length;const firstP=c.firstPurchase;
  const lastP=c.purchases.length?c.purchases[c.purchases.length-1]:null;
  const daysSinceFirst=firstP?daysBetween(firstP,todayStr()):null;
  const daysSinceLast=lastP?daysBetween(lastP.date,todayStr()):null;
  let avgGap=null;if(c.purchases.length>=2){let gaps=[];for(let i=1;i<c.purchases.length;i++){gaps.push(daysBetween(c.purchases[i-1].date,c.purchases[i].date))}avgGap=Math.round(gaps.reduce((a,g)=>a+g,0)/gaps.length)}
  const reorderCycle=c.reorderCycle||90;
  const reorderDue=daysSinceLast!==null&&daysSinceLast>=reorderCycle;
  const warrantyEnd=c.warrantyStart?new Date(new Date(c.warrantyStart).getTime()+730*86400000).toISOString().split('T')[0]:null;
  const warrantyDaysLeft=warrantyEnd?daysBetween(todayStr(),warrantyEnd):null;
  // Analytics
  const hs=calcHealthScore(c);const hsColor=hs>=80?'var(--su)':hs>=50?'var(--org)':'var(--dg)';const hsLabel=hs>=80?'Healthy':hs>=50?'Fair':'At Risk';
  const pb=getProductBreakdown(c);const cr=getConsumptionRate(c);const pred=predictNextOrders(c);
  const timeline=getPurchaseTimeline(c);
  // Personnel
  let persHtml='';const roles={};(c.personnel||[]).forEach(p=>{(roles[p.role]=roles[p.role]||[]).push(p)});
  Object.entries(roles).forEach(([r,ps])=>{persHtml+=`<div style="font-size:10px;font-weight:600;color:var(--t3);margin:8px 0 4px;text-transform:uppercase">${r}s (${ps.length})</div>`;ps.forEach(p=>{persHtml+=`<div class="pers-card"><div class="pers-av" style="background:${CLR[Math.abs(p.name.charCodeAt(0))%8]}">${p.name.split(' ').map(w=>w[0]).slice(0,2).join('')}</div><div style="flex:1"><div style="font-weight:600;font-size:11.5px">${p.name}</div><div style="font-size:10px;color:var(--t3)">${p.notes||r}${p.phone?' · '+p.phone:''}${p.email?' · '+p.email:''}</div></div><button class="btn btn-sm btn-d" onclick="removePerson(${c.id},'${p.name.replace(/'/g,"\\'")}');showClinicDetail(${c.id})">×</button></div>`})});
  // Package
  let pkgHtml='<div style="color:var(--t4);font-size:11px;text-align:center;padding:8px">No initial package</div>';
  if(c.initPkg&&c.initPkg.length>0){pkgHtml=c.initPkg.map(p=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl);font-size:11.5px"><span>${p.product} <span style="color:var(--t3)">× ${p.qty}</span></span><strong style="color:var(--pr)">฿${(p.qty*p.price).toLocaleString()}</strong></div>`).join('')+`<div style="display:flex;justify-content:space-between;padding:6px 0;font-weight:700;font-size:12px"><span>Total</span><span style="color:var(--pr)">฿${(c.initPkgTotal||0).toLocaleString()}</span></div>`}
  // Product consumption bars (max height visual)
  const maxProd=Math.max(pb.balloon,pb.pink,pb.toning,1);
  const prodBarHtml=`<div style="display:flex;gap:16px;align-items:flex-end;height:80px;margin:10px 0">
    <div style="flex:1;text-align:center"><div style="height:${(pb.balloon/maxProd)*60}px;background:var(--blu);border-radius:3px 3px 0 0;min-height:2px;margin:0 auto;width:36px"></div><div style="font-size:16px;font-weight:800;margin:4px 0 0">${pb.balloon}</div><div style="font-size:9px;color:var(--t3)">Balloon</div></div>
    <div style="flex:1;text-align:center"><div style="height:${(pb.pink/maxProd)*60}px;background:var(--pur);border-radius:3px 3px 0 0;min-height:2px;margin:0 auto;width:36px"></div><div style="font-size:16px;font-weight:800;margin:4px 0 0">${pb.pink}</div><div style="font-size:9px;color:var(--t3)">Pink</div></div>
    <div style="flex:1;text-align:center"><div style="height:${(pb.toning/maxProd)*60}px;background:var(--gld);border-radius:3px 3px 0 0;min-height:2px;margin:0 auto;width:36px"></div><div style="font-size:16px;font-weight:800;margin:4px 0 0">${pb.toning}</div><div style="font-size:9px;color:var(--t3)">Toning</div></div>
  </div>`;
  document.getElementById('cdTitle').textContent=c.name+(c.branch!=='—'?' — '+c.branch:'');
  document.getElementById('cdBody').innerHTML=`
  <div class="qa-bar">
    <button class="qa-btn" onclick="openLogActivity(${c.id},'note')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Note</button>
    <button class="qa-btn" onclick="openLogActivity(${c.id},'email')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 6l-10 7L2 6"/><path d="M2 6h20v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>Email</button>
    <button class="qa-btn" onclick="openLogActivity(${c.id},'call')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>Call</button>
    <button class="qa-btn" onclick="openLogActivity(${c.id},'task')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Task</button>
    <button class="qa-btn" onclick="openLogActivity(${c.id},'meeting')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>Meet</button>
    <button class="qa-btn" style="background:var(--pl);border-color:var(--pr);color:var(--pr)" onclick="openRecordPurchase(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Purchase</button>
    <button class="qa-btn" onclick="openAddPerson(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg>Staff</button>
    <button class="qa-btn" style="background:var(--bll);border-color:var(--blu);color:var(--blu)" onclick="openDealFromClinic(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>+ Deal</button>
  </div>

  <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:14px">
    <div style="text-align:center;padding:10px;background:var(--s2);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:${hsColor}">${hs}</div><div style="font-size:9px;color:${hsColor};font-weight:600">${hsLabel}</div></div>
    <div style="text-align:center;padding:10px;background:var(--s2);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:var(--pr)">${fmtB(tp)}</div><div style="font-size:9px;color:var(--t3)">TOTAL SPEND</div></div>
    <div style="text-align:center;padding:10px;background:var(--s2);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:var(--blu)">${purchCount}</div><div style="font-size:9px;color:var(--t3)">ORDERS</div></div>
    <div style="text-align:center;padding:10px;background:var(--s2);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:var(--pur)">${c.dev||0}</div><div style="font-size:9px;color:var(--t3)">DEVICES</div></div>
    <div style="text-align:center;padding:10px;background:var(--s2);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:var(--gld)">${pb.balloon+pb.pink+pb.toning}</div><div style="font-size:9px;color:var(--t3)">CARTRIDGES</div></div>
    <div style="text-align:center;padding:10px;background:var(--s2);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:var(--cyn)">${daysSinceFirst!==null?Math.round(daysSinceFirst/30)+'mo':'—'}</div><div style="font-size:9px;color:var(--t3)">CUSTOMER AGE</div></div>
  </div>

  ${reorderDue?`<div style="padding:10px 14px;background:var(--dl);border-radius:var(--rs);margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:12px"><strong style="color:var(--dg)">⚠ Reorder Overdue</strong><span style="color:var(--dg)">Last order ${daysSinceLast}d ago (cycle: ${reorderCycle}d) — <a href="#" style="color:var(--dg);font-weight:700" onclick="event.preventDefault();openRecordPurchase(${c.id})">Record purchase now →</a></span></div>`:''}

  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:16px">
    <div style="background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);padding:14px">
      <h4 style="font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;color:var(--pr)">📊 Purchase Pattern</h4>
      <div style="font-size:12px;display:grid;gap:5px;color:var(--t3)">
        <div style="display:flex;justify-content:space-between"><span>First Purchase</span><strong style="color:var(--tx)">${firstP?fmtDate(firstP):'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Last Order</span><strong style="color:var(--tx)">${lastP?fmtDate(lastP.date):'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Days Since Last</span><strong style="color:${reorderDue?'var(--dg)':'var(--tx)'}">${daysSinceLast!==null?daysSinceLast+'d':'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Avg Order Gap</span><strong style="color:var(--tx)">${avgGap!==null?avgGap+'d':'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Reorder Cycle</span><strong style="color:var(--tx)">${reorderCycle}d</strong></div>
        <div style="display:flex;justify-content:space-between;padding-top:4px;border-top:1px solid var(--bl)"><span style="font-weight:600">Next Expected</span><strong style="color:${pred&&pred.isOverdue?'var(--dg)':'var(--blu)'}">${pred?fmtDate(pred.nextDate):'—'}</strong></div>
      </div>
      ${timeline.length>=2?`<div style="margin-top:10px;font-size:10px;color:var(--t3)"><strong>Order Timeline:</strong><div style="margin-top:4px;display:flex;flex-direction:column;gap:2px">${timeline.map((t,i)=>`<div style="display:flex;gap:6px;align-items:center"><span style="color:var(--t4);width:70px;font-size:9px">${fmtDate(t.date)}</span><span style="font-weight:600;color:${i===0?'var(--pr)':'var(--blu)'}">${t.label}</span><span style="color:var(--pr);font-weight:600">${fmtB(t.total)}</span>${t.gap?'<span style="color:var(--t4)">← '+t.gap+'d</span>':''}</div>`).join('')}</div></div>`:''}
    </div>
    <div style="background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);padding:14px">
      <h4 style="font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;color:var(--blu)">📦 Consumable Breakdown</h4>
      ${prodBarHtml}
      <div style="font-size:11px;display:grid;gap:4px;margin-top:8px">
        <div style="display:flex;justify-content:space-between"><span style="color:var(--blu);font-weight:600">Balloon</span><span>${pb.balloon} pcs · ${fmtB(pb.balloonAmt)}</span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--pur);font-weight:600">Pink</span><span>${pb.pink} pcs · ${fmtB(pb.pinkAmt)}</span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--gld);font-weight:600">Toning</span><span>${pb.toning} pcs · ${fmtB(pb.toningAmt)}</span></div>
        <div style="display:flex;justify-content:space-between;border-top:1px solid var(--bl);padding-top:4px"><span style="font-weight:600">Device</span><span>${pb.device} units · ${fmtB(pb.deviceAmt)}</span></div>
      </div>
      <div style="margin-top:10px;padding:8px;background:var(--s2);border-radius:var(--rs)">
        <div style="font-size:10px;font-weight:600;color:var(--t3);margin-bottom:4px">MONTHLY CONSUMPTION RATE</div>
        <div style="font-size:11px;display:grid;gap:3px">
          <div style="display:flex;justify-content:space-between"><span>Balloon</span><strong>${cr.balloon}/mo</strong></div>
          <div style="display:flex;justify-content:space-between"><span>Pink</span><strong>${cr.pink}/mo</strong></div>
          <div style="display:flex;justify-content:space-between"><span>Toning</span><strong>${cr.toning}/mo</strong></div>
          <div style="display:flex;justify-content:space-between;border-top:1px solid var(--bl);padding-top:3px"><span style="font-weight:600">Total</span><strong style="color:var(--pr)">${cr.total}/mo</strong></div>
        </div>
      </div>
      ${pred?`<div style="margin-top:10px;padding:8px;background:${pred.isOverdue?'var(--dl)':'var(--bll)'};border-radius:var(--rs)"><div style="font-size:10px;font-weight:600;color:${pred.isOverdue?'var(--dg)':'var(--blu)'};margin-bottom:4px">${pred.isOverdue?'⚠ ESTIMATED OVERDUE ORDER':'🔮 NEXT ORDER ESTIMATE'}</div><div style="font-size:11px;display:grid;gap:2px"><div>Balloon: ~${pred.estBalloon} pcs</div><div>Pink: ~${pred.estPink} pcs</div><div>Toning: ~${pred.estToning} pcs</div><div style="font-weight:700;margin-top:2px">Est. Value: ${fmtB(pred.estTotal)}</div></div></div>`:''}</div>
    <div style="background:var(--wh);border:1px solid var(--bd);border-radius:var(--r);padding:14px">
      <h4 style="font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;color:var(--pur)">ℹ️ Account Info</h4>
      <div style="font-size:12px;display:grid;gap:4px;color:var(--t3)">
        <div style="display:flex;justify-content:space-between"><span>Contact</span><strong style="color:var(--tx)">${c.contact}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Email</span><strong style="color:var(--tx)">${c.email||'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Phone</span><strong style="color:var(--tx)">${c.phone||'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Tier</span><strong style="color:var(--tx)">${c.tier}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Contract</span><strong style="color:var(--tx)">${c.contractType||'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Source</span><strong style="color:var(--tx)">${c.source||'—'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>Monthly Avg</span><strong style="color:var(--tx)">${fmtB(c.avg)}</strong></div>
        <div style="display:flex;justify-content:space-between"><span>KPI Target</span><strong style="color:var(--tx)">${fmtB(c.kpi)}</strong></div>
      </div>
      <div style="margin-top:10px;padding:8px;background:var(--pl);border-radius:var(--rs)">
        <div style="font-size:10px;font-weight:600;color:var(--pr);margin-bottom:4px">💰 AGREED PRICES</div>
        <div style="font-size:11px;display:grid;gap:3px">
          <div style="display:flex;justify-content:space-between"><span>re:H Device</span><strong>฿${getClinicPrice(c,'re:H Device').toLocaleString()}</strong></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--blu)">Balloon</span><strong>฿${getClinicPrice(c,'Balloon').toLocaleString()}</strong></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--pur)">Pink</span><strong>฿${getClinicPrice(c,'Pink').toLocaleString()}</strong></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--gld)">Toning</span><strong>฿${getClinicPrice(c,'Toning').toLocaleString()}</strong></div>
        </div>
      </div>
      <div style="margin-top:10px;padding:8px;background:var(--s2);border-radius:var(--rs)">
        <div style="font-size:10px;font-weight:600;color:var(--t3);margin-bottom:4px">WARRANTY</div>
        <div style="font-size:11px;display:grid;gap:3px">
          <div style="display:flex;justify-content:space-between"><span>Start</span><strong>${c.warrantyStart?fmtDate(c.warrantyStart):'—'}</strong></div>
          <div style="display:flex;justify-content:space-between"><span>Expires</span><strong style="color:${warrantyDaysLeft!==null&&warrantyDaysLeft<90?'var(--dg)':'var(--tx)'}">${warrantyEnd?fmtDate(warrantyEnd):'—'}</strong></div>
          ${warrantyDaysLeft!==null?`<div style="display:flex;justify-content:space-between"><span>Remaining</span><strong style="color:${warrantyDaysLeft<90?'var(--dg)':warrantyDaysLeft<180?'var(--org)':'var(--su)'}">${warrantyDaysLeft}d</strong></div>`:''}
        </div>
      </div>
      <h4 style="font-size:12px;font-weight:700;margin-top:12px;margin-bottom:6px">Initial Package</h4>
      ${pkgHtml}
      ${c.notes?`<div style="margin-top:8px;padding:8px;background:var(--s2);border-radius:var(--rs);font-size:11px;color:var(--t3)"><strong>Notes:</strong> ${c.notes}</div>`:''}
    </div>
  </div>
  <div style="margin-bottom:14px">
    <h4 style="font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px">Activity Timeline (${(c.activities||[]).length}) <span style="font-size:9px;color:var(--t4);font-weight:400;text-transform:uppercase;letter-spacing:.5px">Contact Management</span></h4>
    <div style="max-height:240px;overflow-y:auto;padding-right:4px">${renderActivityTimeline(c,10)}</div>
  </div>

  <div class="cd-section open"><div class="cd-sec-head" onclick="this.parentElement.classList.toggle('open')"><h5>🤝 Associated Deals (${(function(){let cnt=0;Object.keys(pipeline).forEach(s=>pipeline[s].forEach(d=>{if(d.clinicId===c.id)cnt++}));return cnt})()})</h5><span class="cd-sec-arrow">▶</span></div><div class="cd-sec-body">
    ${(function(){let html='';Object.keys(pipeline).forEach(s=>pipeline[s].forEach(d=>{if(d.clinicId===c.id){const ds=calcDealScore(d);html+='<div class="assoc-deal" onclick="closeMo(\'clinicDetail\');navTo(\'orders\');setTimeout(()=>showDealDetail('+d.id+',\''+s+'\'),100)"><div><div class="ad-name">'+d.t+(d.priority?' <span class="dtag '+d.priority+'">'+(d.priority==='urgent'?'Urgent':d.priority)+' </span>':'')+'</div><div class="ad-meta">'+s+' · Score: '+ds.score+'</div></div><div><div class="ad-amt">'+fmtB(d.total||0)+'</div><div class="ad-meta">'+(d.closeDate?'Close: '+fmtDate(d.closeDate):'No date')+'</div></div></div>'}}));return html||'<div style="padding:10px;text-align:center;color:var(--t4);font-size:12px">No deals — <a href="#" style="color:var(--pr)" onclick="event.preventDefault();openDealFromClinic('+c.id+')">Create one →</a></div>'})()}
  </div></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div><h4 style="font-size:12px;font-weight:700;margin-bottom:6px">Key Personnel (${(c.personnel||[]).length}) <button class="btn btn-sm btn-p" onclick="openAddPerson(${c.id})" style="margin-left:8px">+ Add</button></h4>${persHtml||'<div style="padding:12px;text-align:center;color:var(--t4);font-size:12px">No staff — click + Add</div>'}</div>
    <div><h4 style="font-size:12px;font-weight:700;margin-bottom:6px">Order History (${purchCount})</h4>${c.purchases.length?c.purchases.slice().reverse().map(p=>`<div style="padding:6px 0;border-bottom:1px solid var(--bl);font-size:11.5px"><div style="display:flex;justify-content:space-between"><strong>${fmtDate(p.date)}</strong><strong style="color:var(--pr)">${fmtB(p.total)}</strong></div><div style="color:var(--t3)">${p.items} · ${p.payment}</div>${p.products?'<div style="font-size:10px;color:var(--t4);margin-top:2px">'+p.products.map(pr=>pr.name+' ×'+pr.qty+' @฿'+pr.price.toLocaleString()).join(' · ')+'</div>':''}${p.notes?'<div style="color:var(--t4);font-size:10px">'+p.notes+'</div>':''}</div>`).join(''):'<div style="padding:12px;text-align:center;color:var(--t4);font-size:12px">No orders recorded</div>'}</div>
  </div>`;
  openMo('clinicDetail')}
function openAddPerson(cid){document.getElementById('apClinicId').value=cid;document.getElementById('apName').value='';document.getElementById('apPhone').value='';document.getElementById('apEmail').value='';document.getElementById('apNotes').value='';openMo('addPerson')}
function savePersonnel(){const cid=parseInt(document.getElementById('apClinicId').value);const c=getClinic(cid);const name=document.getElementById('apName').value.trim();if(!name||!c){showToast('Error','Name required','error');return}c.personnel.push({name,role:document.getElementById('apRole').value,phone:document.getElementById('apPhone').value,email:document.getElementById('apEmail').value,notes:document.getElementById('apNotes').value});closeMo('addPerson');addAct(`<strong>${name}</strong> added to ${c.name}`,'success');showToast('Added',name);renderAll()}
function removePerson(cid,pname){const c=getClinic(cid);if(!c)return;c.personnel=c.personnel.filter(p=>p.name!==pname);showToast('Removed','Personnel removed');renderAll()}
function loadBranchEdit(val){const c=getClinic(parseInt(val));if(!c){document.getElementById('ebFields').style.display='none';return}document.getElementById('ebFields').style.display='block';document.getElementById('ebTier').value=c.tier;document.getElementById('ebKPI').value=c.kpi;document.getElementById('ebInst').value=c.inst||'';document.getElementById('ebDev').value=c.dev;document.getElementById('ebSpend').value=c.spend;document.getElementById('ebAvg').value=c.avg}
function saveBranchEdit(){const cid=parseInt(document.getElementById('ebClinic').value);const c=getClinic(cid);if(!c){showToast('Error','Select clinic','error');return}c.tier=document.getElementById('ebTier').value;c.kpi=parseInt(document.getElementById('ebKPI').value)||0;c.inst=document.getElementById('ebInst').value||null;c.dev=parseInt(document.getElementById('ebDev').value)||0;c.spend=parseInt(document.getElementById('ebSpend').value)||0;c.avg=parseInt(document.getElementById('ebAvg').value)||0;closeMo('editBranch');addAct(`<strong>${c.name}</strong> branch info updated`,'success');showToast('Updated',c.name);renderAll()}

// ══════════════════════════════════════════════════
// TARGET CLINICS (with First Contact, Demo Date, Follow-up)
// ══════════════════════════════════════════════════
function renderTargets(){
  const stC={not_approached:'n',contacted:'b',waiting:'o',converted:'g'};
  const counts={not_approached:0,contacted:0,waiting:0,converted:0};targets.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
  const total=targets.length||1;
  document.getElementById('targetFunnel').innerHTML=`
    <div style="margin-bottom:12px"><div class="kpi-r"><span>Not Approached</span><strong>${counts.not_approached}</strong></div><div class="prog"><div class="prog-f" style="width:${(counts.not_approached/total)*100}%;background:var(--t4)"></div></div></div>
    <div style="margin-bottom:12px"><div class="kpi-r"><span>Contacted</span><strong>${counts.contacted}</strong></div><div class="prog"><div class="prog-f" style="width:${(counts.contacted/total)*100}%;background:var(--blu)"></div></div></div>
    <div style="margin-bottom:12px"><div class="kpi-r"><span>Waiting Feedback</span><strong>${counts.waiting}</strong></div><div class="prog"><div class="prog-f" style="width:${(counts.waiting/total)*100}%;background:var(--org)"></div></div></div>
    <div style="margin-bottom:12px"><div class="kpi-r"><span>Converted ✓</span><strong style="color:var(--su)">${counts.converted}</strong></div><div class="prog"><div class="prog-f" style="width:${(counts.converted/total)*100}%;background:var(--su)"></div></div></div>
    <div style="margin-top:16px;text-align:center;padding:10px;background:var(--pl);border-radius:var(--rs)"><div style="font-size:18px;font-weight:800;color:var(--pr)">${Math.round(((counts.converted+clinics.filter(c=>c.stage==='active').length)/(targets.length+clinics.length||1))*100)}%</div><div style="font-size:10px;color:var(--t3)">COVERAGE</div></div>`;
  let filtered=currentTargetFilter==='all'?targets:targets.filter(t=>t.status===currentTargetFilter);
  document.getElementById('targetTable').innerHTML=filtered.length?filtered.map(t=>{
    const daysSinceDemo=t.demoDate?daysBetween(t.demoDate,todayStr()):null;
    const followUpDue=daysSinceDemo!==null&&daysSinceDemo>=14&&t.status!=='converted';
    const followUpStatus=t.followUpSent?'<span class="tg g" style="font-size:9px">✓ Sent</span>':followUpDue?'<span class="tg r" style="font-size:9px;cursor:pointer" onclick="event.stopPropagation();sendFollowUp('+t.id+')">⚡ Due — Send</span>':daysSinceDemo!==null?'<span class="tg n" style="font-size:9px">In '+(14-daysSinceDemo)+'d</span>':'<span style="font-size:10px;color:var(--t4)">Set demo date</span>';
    return `<tr><td style="font-weight:600">${t.name}</td><td style="font-size:12px">${t.contact||'—'}</td><td style="font-size:12px">${t.region}</td><td><span class="tg ${stC[t.status]}">${t.status.replace('_',' ')}</span></td><td style="font-size:11px">${t.firstContact?fmtDate(t.firstContact):'—'}</td><td style="font-size:11px">${t.demoDate?fmtDate(t.demoDate):'—'}</td><td>${followUpStatus}</td><td><div style="display:flex;gap:3px" onclick="event.stopPropagation()"><button class="btn btn-sm btn-o" onclick="editTarget(${t.id})">Edit</button>${t.status!=='converted'?`<button class="btn btn-sm btn-p" onclick="convertTarget(${t.id})">Convert</button>`:''}<button class="btn btn-sm btn-d" onclick="removeTarget(${t.id})">×</button></div></td></tr>`}).join(''):'<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--t4)">No targets — click "Add Target Clinic"</td></tr>';
}
function saveTarget(){const name=document.getElementById('tgName').value.trim();if(!name){showToast('Error','Name required','error');return}targets.push({id:targetIdCounter++,name,contact:document.getElementById('tgContact').value,phone:document.getElementById('tgPhone').value,email:document.getElementById('tgEmail').value,region:document.getElementById('tgRegion').value,status:document.getElementById('tgStatus').value,firstContact:document.getElementById('tgFirstContact').value||null,demoDate:document.getElementById('tgDemoDate').value||null,notes:document.getElementById('tgNotes').value,addedDate:todayStr(),followUpSent:false});closeMo('addTarget');document.getElementById('tgName').value='';document.getElementById('tgContact').value='';document.getElementById('tgPhone').value='';document.getElementById('tgEmail').value='';document.getElementById('tgNotes').value='';addAct(`<strong>${name}</strong> added to targets`,'info');showToast('Added',name);renderAll()}
function editTarget(tid){const t=targets.find(x=>x.id===tid);if(!t)return;document.getElementById('etIdx').value=tid;document.getElementById('etFirstContact').value=t.firstContact||'';document.getElementById('etDemoDate').value=t.demoDate||'';document.getElementById('etEmail').value=t.email||'';document.getElementById('etStatus').value=t.status;document.getElementById('etNotes').value=t.notes||'';openMo('editTarget')}
function saveEditTarget(){const tid=parseInt(document.getElementById('etIdx').value);const t=targets.find(x=>x.id===tid);if(!t)return;t.firstContact=document.getElementById('etFirstContact').value||null;t.demoDate=document.getElementById('etDemoDate').value||null;t.email=document.getElementById('etEmail').value;t.status=document.getElementById('etStatus').value;t.notes=document.getElementById('etNotes').value;closeMo('editTarget');addAct(`<strong>${t.name}</strong> target updated`,'success');showToast('Updated',t.name);renderAll()}
function sendFollowUp(tid){const t=targets.find(x=>x.id===tid);if(!t)return;t.followUpSent=true;const emailTo=t.email||t.contact+'@clinic.co.th';notifications.unshift({txt:`Follow-up email sent to ${t.name} (${emailTo})`,time:'Just now',color:'var(--pur)',read:false});addAct(`<strong>AI Follow-up</strong> sent to ${t.name} — 2 weeks post-demo`,'success');showToast('Follow-up Sent',`Email sent to ${emailTo}`);renderAll()}
function convertTarget(tid){const t=targets.find(x=>x.id===tid);if(!t)return;clinics.push({id:clinicIdCounter++,name:t.name,branch:'—',contact:t.contact||'—',email:t.email||'',phone:t.phone||'',region:t.region,stage:'enquiry',source:'Target Pool',tier:'Standard',inst:null,dev:0,spend:0,avg:0,kpi:130000,last:'—',personnel:[],purchases:[],firstPurchase:null,initPkg:[],initPkgTotal:0,contractType:'',warrantyStart:null,reorderCycle:90,notes:'Converted from target pool'+(t.notes?' — '+t.notes:'')});t.status='converted';addAct(`<strong>${t.name}</strong> converted to Lifecycle`,'success');showToast('Converted',t.name);renderAll();populateDropdowns()}
async function removeTarget(tid){const t=targets.find(x=>x.id===tid);if(!t)return;const ok=await confirmDlg('Remove?','Remove "'+t.name+'"?');if(!ok)return;targets=targets.filter(x=>x.id!==tid);renderAll()}

// ══════════════════════════════════════════════════
// ORDERS & PIPELINE (auto-calculate from product prices)
// ══════════════════════════════════════════════════
const PRODUCTS={};inv.forEach(p=>{PRODUCTS[p.n]={cost:p.cost,sell:p.sell}});
function getOrderClinic(){const cid=parseInt(document.getElementById('aoClinic').value);return cid?getClinic(cid):null}
function onOrderClinicChange(){const c=getOrderClinic();const note=document.getElementById('aoPriceNote');if(c&&c.agreedPrices){note.style.display='block';const pr=getClinicPrices(c);note.innerHTML=`💰 <strong>${c.name}</strong> agreed prices: Device ฿${pr.dev.toLocaleString()} · Balloon ฿${pr.bal.toLocaleString()} · Pink ฿${pr.pnk.toLocaleString()} · Toning ฿${pr.ton.toLocaleString()}`}else if(c){note.style.display='block';note.innerHTML=`ℹ️ <strong>${c.name}</strong> — using default list prices`}else{note.style.display='none'}document.getElementById('aoItems').innerHTML='';addOrderLine();recalcOrderTotal()}
function addOrderLine(){const c=getOrderClinic();const container=document.getElementById('aoItems');const row=document.createElement('div');row.className='order-line';
  const prodOpts=['re:H Device','Balloon','Pink','Toning'].map(n=>{const price=c?getClinicPrice(c,n):(PRODUCTS[n]?PRODUCTS[n].sell:0);return`<option value="${n}" data-price="${price}">${n} — ฿${price.toLocaleString()}</option>`}).join('');
  const firstPrice=c?getClinicPrice(c,'re:H Device'):(PRODUCTS['re:H Device']?PRODUCTS['re:H Device'].sell:500000);
  row.innerHTML=`<div class="fg" style="margin:0"><label>Product</label><select class="fi ao-prod" onchange="recalcOrderTotal()">${prodOpts}</select></div><div class="fg" style="margin:0"><label>Qty</label><input class="fi ao-qty" type="number" value="1" min="1" onchange="recalcOrderTotal()" oninput="recalcOrderTotal()"></div><div class="fg" style="margin:0"><label>Unit Price</label><div class="fi ao-price" style="background:var(--s2);font-weight:600">฿${firstPrice.toLocaleString()}</div></div><div class="line-total ao-line">฿${firstPrice.toLocaleString()}</div><button class="btn btn-sm btn-d" onclick="this.parentElement.remove();recalcOrderTotal()" style="margin-bottom:8px;align-self:center">×</button>`;
  container.appendChild(row);recalcOrderTotal()}
function recalcOrderTotal(){const c=getOrderClinic();let grandTotal=0;document.querySelectorAll('.order-line').forEach(row=>{const prodName=row.querySelector('.ao-prod').value;const qty=parseInt(row.querySelector('.ao-qty').value)||0;const price=c?getClinicPrice(c,prodName):(PRODUCTS[prodName]?PRODUCTS[prodName].sell:0);const lineTotal=price*qty;row.querySelector('.ao-price').textContent='฿'+price.toLocaleString();row.querySelector('.ao-line').textContent='฿'+lineTotal.toLocaleString();grandTotal+=lineTotal});document.getElementById('aoTotal').textContent='฿'+grandTotal.toLocaleString()}
function saveOrder(){
  const cid=parseInt(document.getElementById('aoClinic').value);const c=cid?getClinic(cid):null;
  const clinicName=c?c.name:document.getElementById('aoClinic').selectedOptions[0]?.text||'Unknown';
  const stage=document.getElementById('aoStage').value;
  const payment=document.getElementById('aoPayment').value;
  const date=document.getElementById('aoDate').value;
  const notes=document.getElementById('aoNotes').value;
  const closeDate=document.getElementById('aoCloseDate').value;
  const priority=document.getElementById('aoPriority').value;
  let grandTotal=0;const prodArr=[];const itemParts=[];
  document.querySelectorAll('.order-line').forEach(row=>{
    const prodName=row.querySelector('.ao-prod').value;
    const qty=parseInt(row.querySelector('.ao-qty').value)||0;
    const price=c?getClinicPrice(c,prodName):(PRODUCTS[prodName]?PRODUCTS[prodName].sell:0);
    prodArr.push({name:prodName,qty,price});
    itemParts.push(qty+'× '+prodName);grandTotal+=price*qty});
  const itemsStr=itemParts.join(', ')||'New Deal';
  if(grandTotal===0&&!confirm('Total is ฿0 — create anyway?'))return;
  const deal={id:Date.now(),t:itemsStr,c:clinicName,clinicId:cid||null,total:grandTotal,
    d:date?fmtDate(date):'TBD',payment,notes,closeDate:closeDate||null,priority:priority||null,
    products:prodArr,created:todayStr(),
    activities:[{type:'stage',subject:'Deal created → '+stage,body:itemsStr+' · '+fmtB(grandTotal),date:todayStr(),by:'JNA Admin',ts:Date.now()}]};
  pipeline[stage].push(deal);
  closeMo('addOrder');addAct('<strong>New Deal</strong> '+itemsStr+' ('+fmtB(grandTotal)+')','success');
  showToast('Created',itemsStr);renderAll();
  if(c){if(!c.activities)c.activities=[];c.activities.unshift({type:'note',subject:'Deal created: '+itemsStr,body:fmtB(grandTotal)+' · '+stage,date:todayStr(),by:'JNA Admin',ts:Date.now()})}
}
let dragItem=null,dragSource=null;

// ═══════════════════════════════════════════════════
// DEAL SCORING (HubSpot-inspired: Progression + Engagement + Recency)
// ═══════════════════════════════════════════════════
function calcDealScore(deal){
  const stages=['Enquiry','Demo','Proposal','Negotiation','Purchased'];
  const stageIdx=stages.indexOf(deal._stage||'Enquiry');
  // Progression: how far along the pipeline (0-100)
  const progression=Math.round((stageIdx/(stages.length-1))*100);
  // Engagement: based on deal value and notes
  let engagement=30;
  if(deal.total>=500000)engagement+=30;else if(deal.total>=100000)engagement+=20;else if(deal.total>0)engagement+=10;
  if(deal.notes)engagement+=15;
  if(deal.payment)engagement+=10;
  engagement=Math.min(engagement,100);
  // Recency: how recently the deal was created/updated
  let recency=50;
  if(deal.d){const days=daysBetween(deal.d.includes('/')?deal.d:deal.d,todayStr());
    if(days<=7)recency=100;else if(days<=14)recency=85;else if(days<=30)recency=60;else if(days<=60)recency=35;else recency=15}
  // Weighted score
  const score=Math.round(progression*0.35+engagement*0.35+recency*0.30);
  return{score:Math.max(5,Math.min(99,score)),progression,engagement,recency};
}
function dealScoreColor(s){return s>=80?'var(--su)':s>=60?'var(--pr)':s>=40?'var(--org)':'var(--dg)'}

// ═══════════════════════════════════════════════════
// PIPELINE RENDER (enhanced with scores + totals)
// ═══════════════════════════════════════════════════
function renderPipeStats(){
  const stageWeights={Enquiry:0.1,Demo:0.25,Proposal:0.5,Negotiation:0.75,Purchased:1.0};
  const allDeals=Object.values(pipeline).flat();
  const total=allDeals.reduce((a,d)=>a+(d.total||0),0);
  const open=allDeals.filter(d=>d._stage!=='Purchased');
  const openAmt=open.reduce((a,d)=>a+(d.total||0),0);
  const weighted=allDeals.reduce((a,d)=>a+((d.total||0)*(stageWeights[d._stage]||0.1)),0);
  const avgScore=allDeals.length?Math.round(allDeals.reduce((a,d)=>a+(calcDealScore(d).score),0)/allDeals.length):0;
  const avgDeal=allDeals.length?Math.round(total/allDeals.length):0;
  document.getElementById('pipeStats').innerHTML=`
    <div class="pipe-stat-grid">
      <div class="ps-card"><div class="ps-val">${fmtB(total)}</div><div class="ps-label">TOTAL PIPELINE</div></div>
      <div class="ps-card"><div class="ps-val" style="color:var(--blu)">${fmtB(Math.round(weighted))}</div><div class="ps-label">WEIGHTED VALUE</div></div>
      <div class="ps-card"><div class="ps-val">${fmtB(openAmt)}</div><div class="ps-label">OPEN (${open.length})</div></div>
      <div class="ps-card"><div class="ps-val">${avgScore}</div><div class="ps-label">AVG SCORE</div></div>
      <div class="ps-card"><div class="ps-val" style="font-size:14px">${fmtB(avgDeal)}</div><div class="ps-label">AVG / DEAL</div></div>
    </div>`;
}
function renderPipe(){
  renderPipeStats();
  const stages=currentPipeFilter==='all'?Object.keys(pipeline):[currentPipeFilter];
  // Annotate deals with their stage for scoring
  Object.keys(pipeline).forEach(s=>pipeline[s].forEach(d=>d._stage=s));
  document.getElementById('pipeline').innerHTML=stages.map(s=>{
    const items=(pipeline[s]||[]).filter(d=>!dealSearchTerm||(d.t+d.c+(d.notes||'')).toLowerCase().includes(dealSearchTerm));
    const stageTotal=items.reduce((a,d)=>a+(d.total||0),0);
    return`<div class="pcol"><div class="phd"><h4>${s} <span class="pcnt">${items.length}</span></h4><span style="font-size:10.5px;color:var(--t3)">${fmtB(stageTotal)}</span></div><div class="pbd" data-stage="${s}" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="onDrop(event,'${s}')">${items.length?items.map(d=>{
      const ds=calcDealScore(d);const sc=ds.score;const scClr=dealScoreColor(sc);
      const tagHtml=d.priority?'<div class="deal-tags"><span class="dtag '+d.priority+'">'+(d.priority==='urgent'?'🔴 Urgent':d.priority==='hot'?'🔥 Hot':d.priority==='big'?'💰 Big':d.priority==='vip'?'⭐ VIP':'🆕 New')+'</span></div>':'';
      const nextAct=d.notes||'Follow up';const closeStr=d.closeDate?'📅 '+fmtDate(d.closeDate):'';
      return`<div class="dl${selectedDeal&&selectedDeal.id===d.id?' sel':''}" draggable="true" ondragstart="dragSource='${s}';dragItem=${d.id};this.classList.add('dragging')" ondragend="this.classList.remove('dragging')" onclick="showDealDetail(${d.id},'${s}')">
        <div class="dl-score" style="background:${scClr}">${sc}</div>
        <div class="dl-t" style="padding-right:36px">${d.t}</div>
        <div class="dl-c">${d.c}</div>
        ${tagHtml}
        <div class="dl-r"><span class="dl-a">${fmtB(d.total||0)}</span><span class="dl-d">${closeStr}</span></div>
        <div class="dl-meta">${d.payment?'<span>💳 '+d.payment+'</span>':''}<span style="color:var(--blu)">▸ ${nextAct.substring(0,25)}${nextAct.length>25?'...':''}</span></div>
      </div>`}).join(''):'<div style="padding:20px;text-align:center;color:var(--t4);font-size:11px">Drop deals here</div>'}</div><div class="pcol-foot"><span>Total: <strong>${fmtB(stageTotal)}</strong></span><span>${items.length} deal${items.length!==1?'s':''}</span></div></div>`}).join('')}

function togglePipeView(){
  pipeViewMode=pipeViewMode==='kanban'?'list':'kanban';
  const btn=document.getElementById('pipeViewToggle');
  btn.textContent=pipeViewMode==='kanban'?'☰ List':'▦ Kanban';
  document.getElementById('pipeline').style.display=pipeViewMode==='kanban'?'flex':'none';
  document.getElementById('dealListView').style.display=pipeViewMode==='list'?'block':'none';
  if(pipeViewMode==='list')renderDealList();
}
function renderDealList(){
  const allDeals=[];
  Object.keys(pipeline).forEach(s=>pipeline[s].forEach(d=>{d._stage=s;allDeals.push(d)}));
  allDeals.sort((a,b)=>calcDealScore(b).score-calcDealScore(a).score);
  const filteredDeals=dealSearchTerm?allDeals.filter(d=>(d.t+d.c+(d.notes||'')).toLowerCase().includes(dealSearchTerm)):allDeals;
  document.getElementById('dealListView').innerHTML=`<table class="tb"><thead><tr><th>Deal</th><th>Clinic</th><th>Score</th><th>Stage</th><th>Amount</th><th>Close Date</th><th>Priority</th><th>Next Activity</th></tr></thead><tbody>${filteredDeals.map(d=>{
    const ds=calcDealScore(d);const scClr=dealScoreColor(ds.score);
    return`<tr style="cursor:pointer" onclick="showDealDetail(${d.id},'${d._stage}')"><td style="font-weight:600">${d.t}</td><td style="font-size:12px">${d.c}</td><td><span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:${scClr};color:#fff;font-weight:800;font-size:11px">${ds.score}</span></td><td><span class="tg ${({Enquiry:'b',Demo:'o',Proposal:'p',Negotiation:'n',Purchased:'g'})[d._stage]||'b'}">${d._stage}</span></td><td style="font-weight:700;color:var(--pr)">${fmtB(d.total||0)}</td><td style="font-size:11px">${d.closeDate?fmtDate(d.closeDate):'—'}</td><td>${d.priority?'<span class="dtag '+d.priority+'">'+(d.priority==='urgent'?'Urgent':d.priority==='hot'?'Hot':d.priority==='big'?'Big':d.priority==='vip'?'VIP':'New')+'</span>':'—'}</td><td style="font-size:11px;color:var(--blu)">${d.notes||'Follow up'}</td></tr>`}).join('')}</tbody></table>`;
}

// ═══════════════════════════════════════════════════
// DEAL DETAIL PANEL (HubSpot-inspired side panel)
// ═══════════════════════════════════════════════════
function showDealDetail(dealId,stage){
  const deal=pipeline[stage]?pipeline[stage].find(d=>d.id===dealId):null;
  if(!deal)return;
  selectedDeal=deal;selectedDeal._stage=stage;
  const ds=calcDealScore(deal);const scClr=dealScoreColor(ds.score);
  const cl=deal.clinicId?getClinic(deal.clinicId):null;
  const stages=['Enquiry','Demo','Proposal','Negotiation','Purchased'];
  const stageIdx=stages.indexOf(stage);
  // Remove no-detail class
  document.getElementById('pipeWrap').classList.remove('no-detail');
  // Stage tracker
  const stageTracker=stages.map((s,i)=>{
    const cls=i<stageIdx?'done':i===stageIdx?'current':'';
    return`<div class="stage-step"><div class="stage-bar ${cls}"></div><div class="stage-lbl ${cls}">${s}</div></div>`
  }).join('');
  // Score ring SVG
  const circumference=2*Math.PI*38;
  const offset=circumference-(ds.score/100)*circumference;
  const scoreRing=`<div class="ds-ring"><svg width="90" height="90" viewBox="0 0 90 90"><circle cx="45" cy="45" r="38" fill="none" stroke="var(--s3)" stroke-width="6"/><circle cx="45" cy="45" r="38" fill="none" stroke="${scClr}" stroke-width="6" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"/></svg><div class="ds-ring-val" style="color:${scClr}">${ds.score}</div></div>`;
  // Guided actions
  const actions=[];
  if(stageIdx===0)actions.push({icon:'📅',text:'<strong>Schedule demo</strong> to advance this deal'});
  if(stageIdx===1)actions.push({icon:'📄',text:'<strong>Send proposal</strong> — demo completed'});
  if(stageIdx===2)actions.push({icon:'💬',text:'<strong>Start negotiation</strong> — follow up on proposal'});
  if(stageIdx===3)actions.push({icon:'✅',text:'<strong>Close the deal</strong> — finalize contract'});
  if(ds.recency<50)actions.push({icon:'⏰',text:'<strong>Engagement dropping</strong> — reach out today'});
  if(cl&&cl.purchases.length===0&&stageIdx>=2)actions.push({icon:'🎯',text:'<strong>First purchase</strong> opportunity — offer introductory package'});
  if(actions.length===0)actions.push({icon:'🎉',text:'<strong>Deal is healthy</strong> — maintain momentum'});
  // Insights
  let insights='';
  if(cl){
    const hs=calcHealthScore(cl);
    insights+=`<div class="di-card"><div class="di-label">🏥 CLINIC HEALTH</div>Health Score: <strong style="color:${hs>=80?'var(--su)':hs>=50?'var(--org)':'var(--dg)'}">${hs}/100</strong> · ${cl.purchases.length} orders · ${fmtB(cl.spend)} total spend</div>`;
    if(cl.last&&cl.last!=='—'){const dsl=daysBetween(cl.last,todayStr());insights+=`<div class="di-card"><div class="di-label">📊 LAST ACTIVITY</div>Last order <strong>${dsl}d ago</strong> (${fmtDate(cl.last)})</div>`}
  }
  insights+=`<div class="di-card"><div class="di-label">💰 DEAL VALUE</div>${fmtB(deal.total||0)} · ${deal.payment||'No payment method set'}</div>`;

  document.getElementById('dealPanel').innerHTML=`
    <div class="dp-head">
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div>
          <div class="dp-title">${deal.t}</div>
          <div class="dp-sub"><span>🏢 ${deal.c}</span><span>📅 ${deal.d||'No close date'}</span><span>💰 ${fmtB(deal.total||0)}</span></div>
        </div>
        <button class="btn btn-sm btn-o" onclick="document.getElementById('pipeWrap').classList.add('no-detail');selectedDeal=null;renderPipe()">✕</button>
      </div>
      <div class="dp-tags">
        <span class="dp-tag" style="background:${scClr};color:#fff">Score: ${ds.score}</span>
        <span class="dp-tag" style="background:var(--bll);color:var(--blu)">${stage}</span>
        ${deal.payment?'<span class="dp-tag" style="background:var(--pl);color:var(--pr)">'+deal.payment+'</span>':''}
        ${deal.priority?'<span class="dtag '+deal.priority+'">'+(deal.priority==='urgent'?'Urgent':deal.priority==='hot'?'Hot':deal.priority==='big'?'Big':deal.priority==='vip'?'VIP':'New')+'</span>':''}
        ${deal.closeDate?'<span class="dp-tag" style="background:var(--s2);color:var(--t2)">📅 '+fmtDate(deal.closeDate)+'</span>':''}
      </div>
    </div>
    <div class="dp-tabs">
      <div class="dp-tab act" onclick="this.parentElement.querySelectorAll('.dp-tab').forEach(t=>t.classList.remove('act'));this.classList.add('act');document.getElementById('dpSummary').style.display='block';document.getElementById('dpActivity').style.display='none'">Summary</div>
      <div class="dp-tab" onclick="this.parentElement.querySelectorAll('.dp-tab').forEach(t=>t.classList.remove('act'));this.classList.add('act');document.getElementById('dpSummary').style.display='none';document.getElementById('dpActivity').style.display='block'">Activities</div>
    </div>
    <div class="dp-body">
      <div id="dpSummary">
        <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Deal Stage Tracker</div>
        <div class="stage-track">${stageTracker}</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Guided Actions</div>
            ${actions.map(a=>`<div class="ga-item" onclick="${a.icon==='📅'?"advanceDealStage("+deal.id+",'"+stage+"')":''}"><div class="ga-icon">${a.icon}</div><div class="ga-text">${a.text}</div></div>`).join('')}
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:4px">Deal Score <span style="background:var(--bll);color:var(--blu);font-size:9px;padding:1px 6px;border-radius:10px;font-weight:700">AI</span></div>
            ${scoreRing}
            <div class="ds-factors">
              <div class="ds-factor"><div class="ds-factor-dot" style="background:${ds.progression>=60?'var(--su)':'var(--dg)'}"></div><span style="width:70px">Progression</span><div class="ds-factor-bar"><div class="ds-factor-fill" style="width:${ds.progression}%;background:${ds.progression>=60?'var(--su)':'var(--dg)'}"></div></div><span style="width:24px;text-align:right;font-weight:600">${ds.progression}</span></div>
              <div class="ds-factor"><div class="ds-factor-dot" style="background:${ds.engagement>=60?'var(--su)':'var(--org)'}"></div><span style="width:70px">Engagement</span><div class="ds-factor-bar"><div class="ds-factor-fill" style="width:${ds.engagement}%;background:${ds.engagement>=60?'var(--su)':'var(--org)'}"></div></div><span style="width:24px;text-align:right;font-weight:600">${ds.engagement}</span></div>
              <div class="ds-factor"><div class="ds-factor-dot" style="background:${ds.recency>=60?'var(--su)':'var(--dg)'}"></div><span style="width:70px">Recency</span><div class="ds-factor-bar"><div class="ds-factor-fill" style="width:${ds.recency}%;background:${ds.recency>=60?'var(--su)':'var(--dg)'}"></div></div><span style="width:24px;text-align:right;font-weight:600">${ds.recency}</span></div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:4px">Deal Insights <span style="background:var(--bll);color:var(--blu);font-size:9px;padding:1px 6px;border-radius:10px;font-weight:700">AI</span></div>
          ${insights}
        </div>

        <div style="margin-top:16px">
          <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">About this Deal</div>
          ${deal.priority?'<div style="margin-bottom:8px"><span class="dtag '+(deal.priority)+'" style="font-size:10px;padding:3px 10px">'+(deal.priority==='urgent'?'🔴 Urgent':deal.priority==='hot'?'🔥 Hot Deal':deal.priority==='big'?'💰 Big Customer':deal.priority==='vip'?'⭐ VIP':'🆕 New')+'</span></div>':''}
          <div style="font-size:12px;display:grid;gap:4px">
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Deal Name</span><strong>${deal.t}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Company</span><strong>${deal.c}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Amount</span><strong style="color:var(--pr)">${fmtB(deal.total||0)}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Stage</span><strong>${stage}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Close Date</span><strong style="color:${deal.closeDate?'var(--blu)':'var(--t4)'}">${deal.closeDate?fmtDate(deal.closeDate):'Not set'}</strong></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Payment</span><strong>${deal.payment||'—'}</strong></div>
            ${deal.notes?'<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bl)"><span style="color:var(--t3)">Next Activity</span><strong style="color:var(--blu)">'+deal.notes+'</strong></div>':''}
          </div>
        </div>
        ${cl?'<div style="margin-top:16px"><div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Associated Contact</div><div class="assoc-deal" onclick="showClinicDetail('+cl.id+')"><div><div class="ad-name">🏢 '+cl.name+'</div><div class="ad-meta">'+cl.contact+' · '+cl.region+(cl.phone?" · "+cl.phone:"")+'</div></div><div><div class="ad-amt">'+fmtB(cl.spend)+'</div><div class="ad-meta">Total Spend</div></div></div></div>':''}

      </div>
      <div id="dpActivity" style="display:none">
        <div class="qa-bar" style="margin-bottom:12px">
          <button class="qa-btn" onclick="logDealActivity(${deal.id},'${stage}','note')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Note</button>
          <button class="qa-btn" onclick="logDealActivity(${deal.id},'${stage}','email')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 6l-10 7L2 6"/><path d="M2 6h20v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>Email</button>
          <button class="qa-btn" onclick="logDealActivity(${deal.id},'${stage}','call')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.12.84.38 1.85.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.96.32 1.97.58 2.81.7A2 2 0 0122 16.92z"/></svg>Call</button>
          <button class="qa-btn" onclick="logDealActivity(${deal.id},'${stage}','task')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Task</button>
          <button class="qa-btn" onclick="logDealActivity(${deal.id},'${stage}','meeting')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/></svg>Meet</button>
        </div>
        <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Recent Activity</div>
        ${(function(){const dealActs=deal.activities||[];const clinicActs=cl&&cl.activities?cl.activities:[];const all=[...dealActs.map(a=>({...a,src:'deal'})),...clinicActs.map(a=>({...a,src:'clinic'}))].sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,15);return all.length?'<div class="atl">'+all.map(a=>'<div class="atl-item '+a.type+'"><div class="atl-date">'+fmtDate(a.date)+(a.src==='clinic'?' · <span style="color:var(--blu)">Contact</span>':'')+'</div><strong>'+a.subject+'</strong><div style="font-size:11px;color:var(--t3);margin-top:2px">'+(a.body||'')+'</div>'+(a.outcome?'<div style="margin-top:3px"><span class="tg '+(a.outcome==='completed'?'g':a.outcome==='follow-up needed'?'o':'n')+'">'+a.outcome+'</span></div>':'')+'<div class="atl-by">by '+(a.by||'JNA Admin')+'</div></div>').join('')+'</div>':'<div style="padding:20px;text-align:center;color:var(--t4);font-size:12px">No activities yet — use the buttons above to log activity</div>'})()}
      </div>
    </div>
    <div style="padding:12px 16px;border-top:1px solid var(--bd);display:flex;gap:6px">
      <button class="btn btn-p btn-sm" style="flex:1" onclick="advanceDealStage(${deal.id},'${stage}')">Advance Stage →</button>
      ${cl?'<button class="btn btn-o btn-sm" onclick="showClinicDetail('+cl.id+')">View Clinic</button>':''}
    </div>`;
  // Re-render pipe to update selection highlight
  renderPipe();
}

function advanceDealStage(dealId,fromStage){
  const stages=['Enquiry','Demo','Proposal','Negotiation','Purchased'];
  const idx=stages.indexOf(fromStage);
  if(idx>=stages.length-1){showToast('Info','Already at final stage','warning');return}
  const toStage=stages[idx+1];
  const dealIdx=pipeline[fromStage].findIndex(d=>d.id===dealId);
  if(dealIdx===-1)return;
  const deal=pipeline[fromStage].splice(dealIdx,1)[0];
  pipeline[toStage].push(deal);
  if(toStage==='Purchased'){const cl=getClinic(deal.clinicId);if(cl){cl.purchases.push({date:todayStr(),items:deal.t,total:deal.total||0,payment:deal.payment||'Bank Transfer',notes:'From pipeline'});cl.spend+=deal.total||0;cl.last=todayStr()}}
  if(!deal.activities)deal.activities=[];deal.activities.unshift({type:'stage',subject:'Stage → '+toStage,body:'Deal advanced from '+fromStage,date:todayStr(),by:'JNA Admin',ts:Date.now()});
  addAct('<strong>'+deal.t+'</strong> → '+toStage,'success');showToast('Advanced',deal.t+' → '+toStage);
  selectedDeal=deal;
  showDealDetail(deal.id,toStage);
  renderAll();
}

function logDealActivity(dealId,stage,type){
  const deal=pipeline[stage]?pipeline[stage].find(d=>d.id===dealId):null;if(!deal)return;
  const subject=prompt(type.charAt(0).toUpperCase()+type.slice(1)+' subject:');if(!subject)return;
  const body=prompt('Details (optional):');
  if(!deal.activities)deal.activities=[];
  deal.activities.unshift({type,subject,body:body||'',date:todayStr(),by:'JNA Admin',ts:Date.now()});
  // Also log to clinic if linked
  if(deal.clinicId){const cl=getClinic(deal.clinicId);if(cl){if(!cl.activities)cl.activities=[];cl.activities.unshift({type,subject:'[Deal] '+subject,body:(body||'')+' (Deal: '+deal.t+')',date:todayStr(),by:'JNA Admin',ts:Date.now()})}}
  addAct('<strong>'+type+'</strong> logged on '+deal.t,'success');showToast('Logged',type+' on '+deal.t);showDealDetail(dealId,stage)}
let dealSearchTerm='';
function filterDeals(q){dealSearchTerm=q.toLowerCase();renderPipe();if(pipeViewMode==='list')renderDealList()}

function openDealFromClinic(cid){
  const c=getClinic(cid);if(!c)return;closeMo('clinicDetail');
  // Pre-fill order modal with clinic info
  document.getElementById('aoClinic').value=cid;onOrderClinicChange();
  document.getElementById('aoStage').value='Enquiry';
  document.getElementById('aoCloseDate').value='';
  document.getElementById('aoPriority').value='';
  document.getElementById('aoNotes').value='';
  openMo('addOrder');
}

function renderPurchaseHistory(){let all=[];clinics.forEach(c=>c.purchases.forEach(p=>all.push({...p,clinic:c.name})));all.sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.getElementById('purchaseTable').innerHTML=all.length?all.map(p=>`<tr><td style="font-size:12px">${fmtDate(p.date)}</td><td style="font-weight:600">${p.clinic}</td><td style="font-size:12px">${p.items}</td><td style="font-weight:700;color:var(--pr)">${fmtB(p.total)}</td><td style="font-size:11px">${p.payment}</td><td style="font-size:11px;color:var(--t3)">${p.notes||'—'}</td></tr>`).join(''):'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--t4);font-size:12px">No purchases yet</td></tr>'}
function exportPurchaseCSV(){let csv='Date,Clinic,Items,Total,Payment,Notes\n';clinics.forEach(c=>c.purchases.forEach(p=>{csv+=`${p.date},"${c.name}","${p.items}",${p.total},"${p.payment}","${p.notes||''}"\n`}));const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='reh-purchases.csv';a.click();showToast('Export','Downloaded')}

// ══════════════════════════════════════════════════
// INVENTORY (all onclick, no form submit)
// ══════════════════════════════════════════════════
function renderInv(){
  const ic={pr:['var(--pl)','var(--pr)'],blu:['var(--bll)','var(--blu)'],pur:['var(--pul)','var(--pur)'],gld:['var(--gll)','var(--gld)']};
  let filtered=currentInvFilter==='all'?inv:inv.filter(p=>p.cat===currentInvFilter);
  document.getElementById('invGrid').innerHTML=filtered.map(p=>{const c=ic[p.ic]||ic.pr;const margin=p.sell-p.cost;const tIn=p.txns.filter(t=>t.type==='in').reduce((a,t)=>a+t.qty,0);const tOut=p.txns.filter(t=>t.type==='out').reduce((a,t)=>a+t.qty,0);
  return`<div class="inv-c"><div style="display:flex;justify-content:space-between;margin-bottom:10px"><div style="width:38px;height:38px;border-radius:var(--rs);background:${c[0]};display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24" fill="none" stroke="${c[1]}" stroke-width="2" width="18" height="18"><path d="M21 16V8l-7-4-7 4v8l7 4 7-4z"/></svg></div><span class="tg ${p.s===0?'r':p.s<=p.ro?'o':'g'}">${p.s===0?'⊘ Out':p.s<=p.ro?'⚠ Low':'✓ OK'}</span></div>
  <div style="font-weight:700;font-size:13px;margin-bottom:2px">${p.n}</div><div style="font-size:11px;color:var(--t3);margin-bottom:10px">${p.d}</div>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px"><div style="text-align:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-weight:700;font-size:14px;display:block;${p.s<=p.ro?'color:var(--dg)':''}">${p.s}</span><span style="font-size:9px;color:var(--t3)">STOCK</span></div><div style="text-align:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-weight:700;font-size:14px;display:block;color:var(--su)">+${tIn}</span><span style="font-size:9px;color:var(--t3)">IN</span></div><div style="text-align:center;padding:6px;background:var(--s2);border-radius:var(--rs)"><span style="font-weight:700;font-size:14px;display:block;color:var(--dg)">-${tOut}</span><span style="font-size:9px;color:var(--t3)">OUT</span></div></div>
  <div style="font-size:11px;display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px"><div>Cost: <strong>฿${p.cost.toLocaleString()}</strong></div><div>Sell: <strong style="color:var(--pr)">฿${p.sell.toLocaleString()}</strong></div><div>Margin: <strong style="color:var(--su)">฿${margin.toLocaleString()}</strong></div><div>Reorder: <strong>${p.ro}</strong></div></div>
  <button class="btn btn-sm btn-o" onclick="editProduct(${p.id})">Edit Product</button></div>`}).join('')}
function renderInvHistory(){let all=[];inv.forEach(p=>p.txns.forEach(t=>all.push({...t,product:p.n})));all.sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.getElementById('invHistory').innerHTML=all.length?all.map(t=>`<div class="txn-row"><span class="${t.type==='in'?'txn-in':'txn-out'}" style="width:36px;text-align:center">${t.type==='in'?'▲ IN':'▼ OUT'}</span><span style="font-weight:600;width:100px">${t.product}</span><span style="width:50px;font-weight:700">${t.type==='in'?'+':'-'}${t.qty}</span><span style="width:90px">฿${(t.price||0).toLocaleString()}/ea</span><span style="color:var(--t3);flex:1">${t.note||'—'}${t.clinic?' · '+t.clinic:''}</span><span style="color:var(--t4);font-size:10px">${fmtDate(t.date)}</span></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--t4);font-size:12px">No transactions</div>'}
function openInvIn(){document.getElementById('iiQty').value=1;document.getElementById('iiCost').value='';document.getElementById('iiDate').value=todayStr();document.getElementById('iiNote').value='';openMo('invIn')}
function openInvOut(){document.getElementById('ioQty').value=1;document.getElementById('ioPrice').value='';document.getElementById('ioDate').value=todayStr();document.getElementById('ioNote').value='';openMo('invOut')}
function saveInvIn(){
  const pid=parseInt(document.getElementById('iiProduct').value);const p=inv.find(x=>x.id===pid);
  if(!p){showToast('Error','Select product','error');return}
  const qty=parseInt(document.getElementById('iiQty').value)||0;if(qty<1){showToast('Error','Invalid qty','error');return}
  const cost=parseInt(document.getElementById('iiCost').value)||p.cost;
  p.s+=qty;p.txns.push({type:'in',qty,price:cost,date:document.getElementById('iiDate').value||todayStr(),note:document.getElementById('iiNote').value||''});
  closeMo('invIn');addAct(`<strong>Import</strong> +${qty} ${p.n}`,'success');showToast('Recorded','+'+qty+' '+p.n);renderAll()}
function saveInvOut(){
  const pid=parseInt(document.getElementById('ioProduct').value);const p=inv.find(x=>x.id===pid);
  if(!p){showToast('Error','Select product','error');return}
  const qty=parseInt(document.getElementById('ioQty').value)||0;if(qty<1||qty>p.s){showToast('Error',qty>p.s?'Insufficient stock (have '+p.s+')':'Invalid qty','error');return}
  const price=parseInt(document.getElementById('ioPrice').value)||p.sell;const cid=document.getElementById('ioClinic').value;const cl=cid?getClinic(parseInt(cid)):null;
  p.s-=qty;p.txns.push({type:'out',qty,price,date:document.getElementById('ioDate').value||todayStr(),note:document.getElementById('ioNote').value||'',clinic:cl?cl.name:''});
  closeMo('invOut');addAct(`<strong>Sale</strong> -${qty} ${p.n}${cl?' → '+cl.name:''}`,'success');showToast('Recorded','-'+qty+' '+p.n);renderAll()}
function editProduct(pid){const p=inv.find(x=>x.id===pid);if(!p)return;document.getElementById('epIdx').value=pid;document.getElementById('epTitle').textContent='Edit: '+p.n;document.getElementById('epName').value=p.n;document.getElementById('epDesc').value=p.d;document.getElementById('epCost').value=p.cost;document.getElementById('epSell').value=p.sell;document.getElementById('epReorder').value=p.ro;openMo('editProduct')}
function saveProductEdit(){
  const pid=parseInt(document.getElementById('epIdx').value);const p=inv.find(x=>x.id===pid);
  if(!p){showToast('Error','Product not found','error');return}
  p.n=document.getElementById('epName').value;p.d=document.getElementById('epDesc').value;
  p.cost=parseInt(document.getElementById('epCost').value)||0;p.sell=parseInt(document.getElementById('epSell').value)||0;
  p.ro=parseInt(document.getElementById('epReorder').value)||0;
  // Update PRODUCTS lookup
  PRODUCTS[p.n]={cost:p.cost,sell:p.sell};
  closeMo('editProduct');showToast('Updated',p.n+' saved');renderAll();populateDropdowns()}

// ══════════════════════════════════════════════════
// AFTER-SALES SERVICE (pre-selectable issue categories)
// ══════════════════════════════════════════════════
function prefillIssue(val){const el=document.getElementById('atIssue');if(val&&val!=='Other'){el.value=val;if(val.includes('not powering')||val.includes('Overheating'))document.getElementById('atPriority').value='high';else if(val.includes('Preventive')||val.includes('Training')||val.includes('Software'))document.getElementById('atPriority').value='low'}else{el.value='';el.focus()}}
function renderSvc(){
  let filtered=currentSvcFilter==='all'?svc:svc.filter(t=>t.st===currentSvcFilter);
  document.getElementById('svcTable').innerHTML=filtered.length?filtered.map(t=>`<tr>
    <td style="font-weight:600;font-size:11.5px;color:var(--blu)">${t.id}</td>
    <td>${t.cl}</td>
    <td><span class="tg ${t.cat==='Device Issue'?'r':t.cat==='Maintenance'?'b':t.cat==='Training'?'p':'o'}">${t.cat}</span></td>
    <td style="font-size:12px">${t.is}</td>
    <td><span class="tg ${t.pr==='high'?'r':t.pr==='medium'?'o':'b'}">${t.pr.toUpperCase()}</span></td>
    <td><span class="tg ${t.st==='Open'?'r':t.st==='Pending'?'o':'g'}">${t.st}</span></td>
    <td style="font-size:11px">${t.sl}</td>
    <td><select class="fi" style="width:auto;padding:4px 8px;font-size:10.5px" onchange="updateSvcStatus(${t.sid},this.value)"><option value="Open"${t.st==='Open'?' selected':''}>Open</option><option value="Pending"${t.st==='Pending'?' selected':''}>Pending</option><option value="Resolved"${t.st==='Resolved'?' selected':''}>Resolved</option></select></td></tr>`).join(''):'<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--t4)">No tickets — click "New Ticket"</td></tr>';
}
function updateSvcStatus(sid,status){const t=svc.find(x=>x.sid===sid);if(!t)return;t.st=status;if(status==='Resolved')t.sl='Done';addAct(`<strong>${t.id}</strong> → ${status}`,'success');showToast('Updated',t.id);renderAll()}
function categorizeIssue(issue){if(issue.match(/power|RF energy|error code|overheating|screen|needle depth|cartridge not connect/i))return'Device Issue';if(issue.match(/preventive|warranty|replacement|firmware|software/i))return'Maintenance';if(issue.match(/training/i))return'Training';return'General'}
function saveTicket(){
  const cid=parseInt(document.getElementById('atClinic').value);if(!cid){showToast('Error','Select clinic','error');return}
  const cl=getClinic(cid);const category=document.getElementById('atCategory').value;const issue=document.getElementById('atIssue').value.trim();
  if(!issue){showToast('Error','Issue required','error');return}
  const id='SVC-'+String(svcIdCounter++).padStart(3,'0');
  svc.unshift({sid:svcIdCounter,id,cl:cl?cl.name:'—',dv:document.getElementById('atDevice').value||'—',cat:categorizeIssue(issue),is:issue,pr:document.getElementById('atPriority').value,st:'Open',sl:document.getElementById('atSLA').value});
  closeMo('addTicket');document.getElementById('atIssue').value='';document.getElementById('atCategory').value='';document.getElementById('atDevice').value='';
  addAct(`<strong>${id}</strong> created for ${cl?cl.name:'—'}`,'warning');showToast('Created',id);renderAll()}

// ══════════════════════════════════════════════════
// AI AGENTS
// ══════════════════════════════════════════════════
function renderAI(){
  const ic={blu:['var(--bll)','var(--blu)'],org:['var(--orl)','var(--org)'],pr:['var(--pl)','var(--pr)'],pur:['var(--pul)','var(--pur)'],gld:['var(--gll)','var(--gld)'],g:['var(--sl)','var(--su)']};
  document.getElementById('aiGrid').innerHTML=aiAgents.map((a,i)=>{const c=ic[a.c];return`<div class="inv-c"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><div style="width:38px;height:38px;border-radius:var(--rs);background:${c[0]};display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24" fill="none" stroke="${c[1]}" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div><span class="tg g"><span style="width:6px;height:6px;border-radius:50%;background:var(--su);display:inline-block;animation:pulse 2s infinite"></span>${a.st}</span></div><div style="font-weight:700;font-size:13px">${a.n}</div><div style="font-size:11px;color:var(--t3);margin-bottom:10px">${a.d}</div><div style="font-size:11px;color:var(--t3);padding:8px;background:var(--s2);border-radius:var(--rs)">${a.m}</div><div style="margin-top:8px;display:flex;gap:4px"><button class="btn btn-sm btn-o" onclick="configAgent(${i})">Configure</button><button class="btn btn-sm btn-o" onclick="showLogs(${i})">Logs</button></div></div>`}).join('')}
function configAgent(i){const a=aiAgents[i];document.getElementById('agentConfigTitle').textContent='Configure: '+a.n;document.getElementById('agentConfigBody').innerHTML=`<div class="fg"><label>Agent Name</label><input class="fi" value="${a.n}"></div><div class="fg"><label>Description</label><textarea class="fi" rows="3">${a.d}</textarea></div><div style="margin-top:8px"><div class="toggle-row"><div class="tog-i"><span>Enabled</span><span>Agent active</span></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div><div class="toggle-row"><div class="tog-i"><span>Auto-notify team</span><span>CC to team</span></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div></div>`;openMo('agentConfig')}
function showLogs(i){const a=aiAgents[i];document.getElementById('agentLogsTitle').textContent=a.n+' — Logs';const now=new Date();const logs=[];for(let j=0;j<8;j++){const t=new Date(now-j*1800000);logs.push({time:t.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'}),msg:['Processed email','Classification done','Auto-response sent','Record created','KPI check','Inventory scan','Reorder alert','Forecast updated'][j%8],st:['success','success','success','info','success','info','warning','success'][j%8]})}document.getElementById('agentLogsBody').innerHTML=`<div style="font-size:11px;color:var(--t3);margin-bottom:12px">${a.m}</div><table class="tb"><thead><tr><th>Time</th><th>Event</th><th>Status</th></tr></thead><tbody>${logs.map(l=>`<tr><td style="font-size:11px;font-family:monospace">${l.time}</td><td style="font-size:12px">${l.msg}</td><td><span class="tg ${l.st==='success'?'g':l.st==='warning'?'o':'b'}">${l.st}</span></td></tr>`).join('')}</tbody></table>`;openMo('agentLogs')}

// ══════════════════════════════════════════════════
// ACTIVITY LOGGING (Contact Management)
// ══════════════════════════════════════════════════
function openLogActivity(cid,type){
  document.getElementById('laClinicId').value=cid;
  document.getElementById('laType').value=type||'note';
  document.getElementById('laDate').value=todayStr();
  document.getElementById('laSubject').value='';
  document.getElementById('laBody').value='';
  document.getElementById('laOutcome').value='';
  document.getElementById('laTitle').textContent={note:'Log Note',call:'Log Call',email:'Log Email',task:'Log Task',meeting:'Log Meeting'}[type||'note'];
  document.getElementById('laIcon').textContent={note:'📝',call:'📞',email:'✉️',task:'📋',meeting:'🤝'}[type||'note'];
  openMo('logActivity');
}
function saveActivity(){
  const cid=parseInt(document.getElementById('laClinicId').value);
  const c=getClinic(cid);if(!c)return;
  const type=document.getElementById('laType').value;
  const subject=document.getElementById('laSubject').value.trim()||('New '+type);
  const body=document.getElementById('laBody').value;
  const date=document.getElementById('laDate').value||todayStr();
  const outcome=document.getElementById('laOutcome').value;
  if(!c.activities)c.activities=[];
  c.activities.unshift({type,subject,body,date,outcome,by:'JNA Admin',ts:Date.now()});
  closeMo('logActivity');
  addAct('<strong>'+{note:'Note',call:'Call',email:'Email',task:'Task',meeting:'Meeting'}[type]+'</strong> logged for '+c.name,'success');
  showToast('Logged',subject);renderAll();
}
function renderActivityTimeline(c,limit){
  if(!c.activities||!c.activities.length)return'<div style="padding:16px;text-align:center;color:var(--t4);font-size:12px">No activities yet — use quick actions above to start logging.</div>';
  const items=c.activities.slice(0,limit||15);
  const icons={note:'📝',call:'📞',email:'✉️',task:'📋',meeting:'🤝',purchase:'💰',stage:'🔄'};
  return'<div class="atl">'+items.map(a=>`<div class="atl-item ${a.type}">
    <div class="atl-date">${fmtDate(a.date)} · ${icons[a.type]||'📝'} ${a.type.charAt(0).toUpperCase()+a.type.slice(1)}</div>
    <strong>${a.subject}</strong>
    ${a.body?'<div style="font-size:11px;color:var(--t3);margin-top:2px">'+a.body+'</div>':''}
    ${a.outcome?'<div style="margin-top:3px"><span class="tg '+(a.outcome==='completed'?'g':a.outcome==='follow-up needed'?'o':'n')+'">'+a.outcome+'</span></div>':''}
    <div class="atl-by">by ${a.by||'JNA Admin'}</div>
  </div>`).join('')+'</div>';
}


// ══════════════════════════════════════════════════
// SETTINGS
// ══════════════════════════════════════════════════
const settingsTabs=[
  {id:'email',label:'Email Integration',content:()=>`<h3 style="font-size:15px;font-weight:700;margin-bottom:3px">Email Integration</h3><p style="font-size:12px;color:var(--t3);margin-bottom:18px">Connect sales email to auto-capture enquiries.</p><div class="fr"><div class="fg"><label>Sales Email</label><input class="fi" value="sales@jnacorporation.com"></div><div class="fg"><label>IMAP Server</label><input class="fi" value="imap.jnacorporation.com:993"></div></div><div class="fr"><div class="fg"><label>SMTP Server</label><input class="fi" value="smtp.jnacorporation.com:587"></div><div class="fg"><label>Polling</label><select class="fi"><option>Every 2 min</option><option>Every 5 min</option></select></div></div><div style="margin-top:12px;padding:12px;background:var(--orl);border-radius:var(--rs);font-size:11.5px;color:var(--org)"><strong>⚠ Backend Required:</strong> Real email sync needs server-side IMAP/SMTP connector. Current mode: <strong>Simulated</strong>.</div><div style="margin-top:16px"><h4 style="font-size:13px;font-weight:600;margin-bottom:10px">AI Classification</h4><div class="toggle-row"><div class="tog-i"><span>Auto-create Enquiry Records</span><span>Email → Lifecycle</span></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div><div class="toggle-row"><div class="tog-i"><span>Auto-detect Reorders</span><span>Classify reorder emails</span></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div><div class="toggle-row"><div class="tog-i"><span>Auto-route Service Issues</span><span>Issues → tickets</span></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div></div><div style="margin-top:16px;display:flex;gap:6px"><button class="btn btn-p" onclick="showToast('Saved','Email settings saved')">Save</button><button class="btn btn-o" onclick="showToast('Info','Backend needed','warning')">Test</button></div>`},
  {id:'general',label:'General',content:()=>`<h3 style="font-size:15px;font-weight:700;margin-bottom:18px">General</h3><div class="fr"><div class="fg"><label>Company</label><input class="fi" value="JNA Corporation"></div><div class="fg"><label>Currency</label><select class="fi"><option>THB (฿)</option><option>USD ($)</option></select></div></div><div class="fr"><div class="fg"><label>Timezone</label><select class="fi"><option>Asia/Bangkok (UTC+7)</option></select></div><div class="fg"><label>Date Format</label><select class="fi"><option>YYYY-MM-DD</option><option>DD/MM/YYYY</option></select></div></div><div style="margin-top:16px"><button class="btn btn-p" onclick="showToast('Saved','Settings saved')">Save</button></div>`},
  {id:'team',label:'Team',content:()=>`<h3 style="font-size:15px;font-weight:700;margin-bottom:18px">Team</h3><table class="tb"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th></tr></thead><tbody>${users.filter(u=>u.email!=='demo').map(u=>`<tr><td style="font-weight:600">${u.name}</td><td style="font-size:11px;color:var(--t3)">${u.email}</td><td>${u.role}</td><td><span class="tg g">Active</span></td></tr>`).join('')}</tbody></table>`},
  {id:'kpi',label:'KPI Targets',content:()=>`<h3 style="font-size:15px;font-weight:700;margin-bottom:18px">KPI Targets</h3><div class="fr"><div class="fg"><label>Premium (฿/mo)</label><input class="fi" type="number" value="200000"></div><div class="fg"><label>Standard (฿/mo)</label><input class="fi" type="number" value="130000"></div></div><div class="fr"><div class="fg"><label>Starter (฿/mo)</label><input class="fi" type="number" value="60000"></div><div class="fg"><label>Coverage Target (%)</label><input class="fi" type="number" value="80"></div></div><div style="margin-top:16px"><button class="btn btn-p" onclick="showToast('Saved','KPI saved')">Save</button></div>`},
  {id:'followup',label:'Follow-up Rules',content:()=>`<h3 style="font-size:15px;font-weight:700;margin-bottom:18px">Automated Follow-up</h3><div class="fg"><label>Post-Demo Follow-up Delay (days)</label><input class="fi" type="number" value="14"></div><div class="fg"><label>Follow-up Email Template</label><textarea class="fi" rows="5">Dear {contact_name},\n\nThank you for attending the re:H demonstration on {demo_date}.\n\nWe would love to discuss how re:H can benefit {clinic_name}. Please let us know a convenient time for a follow-up call.\n\nBest regards,\nJNA Corporation Sales Team</textarea></div><div style="margin-top:16px"><button class="btn btn-p" onclick="showToast('Saved','Follow-up template saved')">Save Template</button></div>`},
  {id:'warranty',label:'Warranty',content:()=>`<h3 style="font-size:15px;font-weight:700;margin-bottom:18px">Warranty Policies</h3><div class="fr"><div class="fg"><label>re:H Device Warranty (months)</label><input class="fi" type="number" value="24"></div><div class="fg"><label>PM Interval (months)</label><input class="fi" type="number" value="6"></div></div><div style="margin-top:16px"><button class="btn btn-p" onclick="showToast('Saved','Warranty saved')">Save</button></div>`},
];
let activeSettingsTab='email';
function initSettings(){document.getElementById('setNav').innerHTML=settingsTabs.map(t=>`<div class="set-ni${t.id===activeSettingsTab?' act':''}" data-tab="${t.id}" onclick="switchSettingsTab('${t.id}')">${t.label}</div>`).join('');switchSettingsTab('email')}
function switchSettingsTab(id){activeSettingsTab=id;document.querySelectorAll('.set-ni').forEach(n=>n.classList.toggle('act',n.dataset.tab===id));const tab=settingsTabs.find(t=>t.id===id);if(tab)document.getElementById('setPanels').innerHTML=tab.content()}
</script>
</body>
</html>